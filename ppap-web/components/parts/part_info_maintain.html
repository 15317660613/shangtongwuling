﻿<!--
File   : part_info_maintain.html
Created: 2018-12-13 14:20
Author : Zhao Pengxiang
Description: 零件信息维护页面
-----
Last Modified: 2018-12-21 09:00
Modified By  : Qitian
Description: 页面修改、js逻辑控制、前后端接口对接
-----
-->
<style>
    .select-inline {
        width: 150px;
    }
    .xm-select-parent .xm-form-select dl {
        /* 马 2019-03-13 修复无效css */
        /* max-height: 230px;!important; */
        max-height: 230px;
        /* 马 2019-03-13 修复无效css 结束 */
    }

    .nostyle-btn {
        color: rgba(148, 148, 148, 1);
        width: 121px;
        height: 27px;
        background: rgba(255, 255, 255, 1);
        border-radius: 2px;
        border: 1px solid rgba(202, 202, 202, 1);
        font-size: 14px;
        margin-left: 10px;
    }

    .nostyle-btn img {
        margin-right: 5px;
        margin-top: -4px;
    }

    .layui-table-box {
        overflow-x: auto;
    }

    .layui-table-header {
        overflow: initial;
    }

    table {
        width: 100% !important;
    }

    .layui-table-view .layui-table-box select {
        height: 27px;
    }

    .table-top-bar input {
        border: none
    }

    .table-top-bar .layui-form-label, .searcher-panel .layui-form-label {
        width: 102px;
    }

    .searcher-panel .layui-input-block {
        margin-left: 132px;
    }

    .linkage-panel .layui-form-item {
        float: left;
        clear: initial;
        width: 300px;
    }

    .searcher-panel .search-item {
        float: left;
        width: 300px;
        margin-bottom: 10px;
    }

    .searcher-panel input {
        text-overflow: ellipsis;
    }

    .linkage-panel .layui-input-block, .searcher-panel .layui-input-block {
        margin-left: 132px;
    }

    .layui-form-select .layui-input {
        padding-right: 10px;
    }
    .layui-card-body{
        height: auto;
    }
    .layui-layout-admin .layui-body {
        overflow-y: auto;
    }
    .title-bar {
        line-height: 14px;
        background-color: white;
        border-left: 3px solid  #00a0e9;
        margin-bottom: 0px;
        padding-top: 9px;
        padding-bottom: 9px;
        position: relative;
        top: 5px;
        font-weight: 600;
        font-size: 16px;
    }
    .title-bar-icon {
        position: absolute;
        top: 61px;
        right: 26px;
    }
    /* 马 2019-03-13 修复无效css */
    /* div[xm-select-skin=default] dl dd:not(.xm-dis-disabled) i {border-color: #1E9FFF}         .xm-select-parent .xm-form-select dl {             max-height: 230px;!important;         } */
    div[xm-select-skin=default] dl dd:not(.xm-dis-disabled) i {border-color: #1E9FFF}
    .xm-select-parent .xm-form-select dl {max-height: 230px;}
    /* 马 2019-03-13 修复无效css 结束 */
    div[xm-select-skin=default] dl dd.xm-select-this:not(.xm-dis-disabled) i {color: #1E9FFF}

    .xm-input xm-select {
        height: 30px !important;
    }

    .xm-select {
        height: 30px !important;

    }

    .xm-select-parent .xm-select {
        min-height: 30px !important;
    }

    .xm-select-parent .xm-input {
        height: 30px;
        padding-top: 0px;
        /* 马 2019-03-13 修复无效css */
        /* !important; */
        /* 马 2019-03-13 修复无效css 结束 */
    }
</style>
<div class="layui-row layui-col-space15" id="part_info_maintain">
    <!-- 检索面板 -->
    <!--by ma 2019-04-12 17:32:00-->
    <div style="margin: 0 0 0 0;" class="">
        <div class="layui-card p-main">
            <!--<div class="layui-card-header">数据查找</div>-->
            <div onclick="flexSearcherPanel()" style="border-bottom: solid 1px #e3dfdf;">
                <div style="height: 42px">
                    <blockquote class="layui-elem-quote title-bar">
                        数据查找
                    </blockquote>
                    <div id="searcher-div-close" class="layui-hide title-bar-icon">
                        <span style="color: #949494">收起</span>
                        <a style="margin-left: 10px"><img src="../../assets/images/arrowup.png" alt="../../assets/images/arrowup.png"></a>
                    </div>
                    <div id="searcher-div-open" class="title-bar-icon">
                        <span style="color: #949494">展开</span>
                        <a style="margin-left: 10px"><img src="../../assets/images/arrowdown.png" alt="../../assets/images/arrowdown.png"></a>
                    </div>
                </div>
                <!-- <hr style="margin-top: 0px">-->
            </div>
            <!-- 搜索面板 -->
            <div class="layui-card searcher-panel layui-hide" style="padding-top: 15px;">
                <form id="search_div" class="layui-form" lay-filter="search-form-content">
                    <!--每一个搜索项中必须设定name值(与后台对接的字段名一致)和class:params-item，用来执行搜索功能时取参数用-->
                    <!--每一个搜索项需要放动态下拉菜单的一级父元素必须绑定id值（与后台对接的字段名一致），用来请求数据成功后，append动态数据-->
                    <!--sqe登陆-->
                    <!--其他人登陆（供应商除外）-->
                    <!--供应商除外-->
                </form>
            </div>
        </div>
    </div>
    <!--表格区域-->
    <!--by ma 2019-04-12-->
    <div class="">
        <div class="layui-card p-main" style="padding-bottom: 15px;">
            <div style="height: 42px">
                <blockquote class="layui-elem-quote title-bar">
                    零件列表
                </blockquote>
            </div>
            <hr style="margin-top: 0px">
            <!-- 卡片容器 -->
            <div class="layui-card-body " id="taskBody">
                <!-- 数据表格顶部控制栏 -->
                <div class="layui-form">
                    <div class="layui-form-item table-top-bar linkage-panel">
                        <div class="layui-col-md12">
                            <div class="layui-col-md3">
                                <label class="layui-form-label">项目单编号：</label>
                                <div class="layui-input-block">
                                    <input style="background-color: #0d96ff2b;border-radius: 5px;"
                                           type="text" id="linkage-itemtrackingnum" readonly placeholder=""
                                           autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <label class="layui-form-label">车型/机型：</label>
                                <div class="layui-input-block">
                                    <input style="background-color: #0d96ff2b;border-radius: 5px;" type="text" id="linkage-projectmodel" readonly placeholder=""
                                           autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <label class="layui-form-label">BETA/OTS1：</label>
                                <div class="layui-input-block">
                                    <input style="background-color: #0d96ff2b;border-radius: 5px;" type="text" id="linkage-ots1" readonly placeholder="" autocomplete="off"
                                           class="layui-input">
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <label class="layui-form-label">GAMMA/OTS2：</label>
                                <div class="layui-input-block">
                                    <input style="background-color: #0d96ff2b;border-radius: 5px;" type="text" id="linkage-ots2" readonly placeholder="" autocomplete="off"
                                           class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-md12">
                            <div class="layui-col-md3">
                                <label class="layui-form-label">3C Pilot/NS：</label>
                                <div class="layui-input-block">
                                    <input style="background-color: #0d96ff2b;border-radius: 5px;" type="text" id="linkage-ns" readonly placeholder="" autocomplete="off"
                                           class="layui-input">
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <label class="layui-form-label">Pilot/S：</label>
                                <div class="layui-input-block">
                                    <input style="background-color: #0d96ff2b;border-radius: 5px;" type="text" id="linkage-stime" readonly placeholder="" autocomplete="off"
                                           class="layui-input">
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <label class="layui-form-label">SOP：</label>
                                <div class="layui-input-block">
                                    <input style="background-color: #0d96ff2b;border-radius: 5px;" type="text" id="linkage-soptime" readonly placeholder="" autocomplete="off"
                                           class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="layui-col-md12">
                            <div id="update_btn" class="layui-inline" style="float: left">
                                <div class="layui-inline">
                                    <div class="layui-inline">
                                        <button id="btn_add" type="button" class="layui-btn layui-btn-sm" lay-submit
                                                lay-filter="addPart" style="background-color: #01D1C9">新增
                                        </button>
                                    </div>
                                    <div class="layui-inline">
                                        <button id="btn_delete" type="button" class="layui-btn layui-btn-sm" lay-submit
                                                lay-filter="deletePart" style="background-color: #FF8C85">删除
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-inline layui-pull-right">
                                <div class="layui-inline">
                                    <div class="layui-inline">
                                        <button class="nostyle-btn" type="button" lay-submit lay-filter="exportAllPart">
                                            <img src="../../assets/images/export.png" alt="../../assets/images/export.png"> 总清单导出
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 下部表格容器 -->
                <div class="table-round" id="table_div">
                    <table id="parts-manage-table" lay-filter="parts-manage-table"></table>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    var loadDatas;//数据加载方法地址
    var loadSearch;//搜索面板中的下拉面板数据绑定事件地址
    var tableInit;
    //登录人信息
    var USER = {};
    //项目车型机型list
    // var projectmodel=[]

    //多选项
    // var multipleItems = ['alert', 'source', 'projectmodel', 'suppliername', 'riskinspectionresults'];
    var multipleItems = ['alert', 'source', 'projectmodel', 'suppliername', 'riskinspectionresults'];
    //新的多选框id数组
    var newMultipleItems = ['suppliercode','suppliername','latestpartnum','partsname','itemtrackingnum','projectmodel']
    sessionStorage.removeItem('requestPartsObj');//清除检索记录
    // 初始化 layui
    layui.use(['table', 'laydate', 'formSelects'], function () {
        var table, form, config, admin, laydate;
        table = layui.table,
            form = layui.form,
            config = layui.config,
            admin = layui.adc,
            laydate = layui.laydate,
            formSelects = layui.formSelects;
        USER = config.getAccount();
        $('#update_btn').hide()
        //SQE搜索项绑定
        $('#sqe').val(USER.userName);
        $('input[name="sqe"]').val(USER.userId);
        var html1 = '                    <div id="search_div_2" style="margin-bottom: 0;display: none" class="layui-form-item">\n' +
            '                        <div class="layui-col-md12">\n' +
            '                            <div class="layui-col-md3" id="sqe2">\n' +
            '                                <label class="layui-form-label">SQE：</label>\n' +
            '                                <div class="layui-input-block" id="sqe_div">\n' +
            '                                    <select class="layui-input params-item" name="sqe" id="sqe"lay-filter="sqe"></select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">预警状态：</label>\n' +
            '                                <div class="layui-input-block layui-unselect layui-form-select downpanel">\n' +
            '                                    <div class="layui-select-title self-select-title ">\n' +
            '                                        <input type="text" placeholder="请选择" value="" name="alert" readonly=""\n' +
            '                                               class="layui-input layui-unselect params-item" id="search-input-alert">\n' +
            '                                    </div>\n' +
            '                                    <dl class="layui-anim layui-anim-upbit" style="" id="alert">\n' +
            '                                        <!--\n' +
            '                                                                                    <dd><input type="checkbox" class="check-all" name="alert" title="请选择" lay-filter="chooseAllPeroson" value="" lay-skin="primary" ></dd>\n' +
            '                                        -->\n' +
            '                                        <dd><input type="checkbox" title="R" value="R" name="alert" lay-skin="primary">\n' +
            '                                        </dd>\n' +
            '                                        <dd><input type="checkbox" title="Y" value="Y" name="alert" lay-skin="primary">\n' +
            '                                        </dd>\n' +
            '                                        <dd><input type="checkbox" title="W" value="W" name="alert" lay-skin="primary">\n' +
            '                                        </dd>\n' +
            '                                        <dd><input type="checkbox" title="无计划" value="无计划" name="alert" lay-skin="primary">\n' +
            '                                        </dd>\n' +
            '                                    </dl>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">来源：</label>\n' +
            '                                <div class="layui-input-block layui-unselect layui-form-select downpanel">\n' +
            '                                    <div class="layui-select-title self-select-title ">\n' +
            '                                        <input type="text" placeholder="请选择" value="" readonly="" name="source"\n' +
            '                                               class="layui-input layui-unselect params-item" id="search-input-source">\n' +
            '                                    </div>\n' +
            '                                    <dl class="layui-anim layui-anim-upbit" style="" id="source">\n' +
            '                                        <!--\n' +
            '                                                                                    <dd><input type="checkbox" class="check-all" name="source" title="请选择" lay-filter="chooseAllPeroson" value="" lay-skin="primary" ></dd>\n' +
            '                                        -->\n' +
            '                                        <dd><input type="checkbox" title="项目阶段" name="source" value="项目阶段"\n' +
            '                                                   lay-skin="primary"></dd>\n' +
            '                                        <dd><input type="checkbox" title="量产阶段(过程变更)" name="source" value="量产阶段(过程变更)"\n' +
            '                                                   lay-skin="primary"></dd>\n' +
            '                                        <dd><input type="checkbox" title="量产阶段(EWO变更)" name="source" value="量产阶段(EWO变更)"\n' +
            '                                                   lay-skin="primary"></dd>\n' +
            '                                        <dd><input type="checkbox" title="量产阶段(新增供应商)" name="source" value="量产阶段(新增供应商)"\n' +
            '                                                   lay-skin="primary"></dd>\n' +
            '                                        <dd><input type="checkbox" title="量产阶段(其他)" name="source"\n' +
            '                                                   value="量产阶段(其他)" lay-skin="primary"></dd>\n' +
            '                                    </dl>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">项目单编号：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <select class="layui-input params-item" name="itemtrackingnum" id="itemtrackingnum" lay-search=""\n' +
            '                                            lay-filter="itemtrackingnum" xm-select="itemTrackingNum" xm-select-show-count="1" xm-select-skin="default" xm-select-search=""></select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                        </div>\n' +
            '                        <div class="layui-col-md12">\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">车型/机型：</label>\n' +
            '                                <div class="layui-input-block layui-unselect layui-form-select downpanel">\n' +
            '                                    <div class="layui-select-title self-select-title ">\n' +
            //            '                                        <input type="text" placeholder="请选择" value="" name="projectmodel" readonly=""\n' +
            //            '                                               class="layui-input layui-unselect params-item"\n' +
            //            '                                               id="search-input-projectmodel">\n' +
            '                                    <select class="layui-input params-item" name="projectmodel" id="search-input-projectmodel" lay-search=""\n' +
            '                                            lay-filter="projectmodel" xm-select="projectModel" xm-select-show-count="1" xm-select-skin="default" xm-select-search=""></select>\n' +
            '                                    </div>\n' +
            '                                    <dl class="layui-anim layui-anim-upbit" style="" id="projectmodel">\n' +
            '\n' +
            '                                    </dl>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">供应商代码：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <select class="layui-input params-item" name="suppliernum" id="suppliernum" lay-search=""\n' +
            '                                            lay-filter="suppliernum" xm-select="supplierCode" xm-select-show-count="1" xm-select-skin="default" xm-select-search=""></select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">供应商名称</label>\n' +
            '                                <div class="layui-input-block layui-unselect layui-form-select downpanel">\n' +
            '                                    <div class="layui-select-title self-select-title ">\n' +
            //            '                                        <input type="text" placeholder="请选择" value="" name="suppliername" readonly=""\n' +
            //            '                                               class="layui-input layui-unselect params-item"\n' +
            //            '                                               id="search-input-suppliername">\n' +
            '                                    <select class="layui-input params-item" name="suppliername" id="search-input-suppliername" lay-search=""\n' +
            '                                            lay-filter="suppliername" xm-select="supplierName" xm-select-show-count="1" xm-select-skin="default" xm-select-search=""></select>\n' +
            '                                    </div>\n' +
            '                                    <dl class="layui-anim layui-anim-upbit" style="" id="suppliername">\n' +
            '\n' +
            '                                    </dl>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">最新零件号：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <select class="layui-input params-item" name="latestpartnum" id="latestpartnum" lay-search=""\n' +
            '                                            lay-filter="latestpartnum" xm-select="latestpartNum" xm-select-show-count="1" xm-select-skin="default" xm-select-search=""></select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                        </div>\n' +
            '                        <div class="layui-col-md12">\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">零件名称：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <select class="layui-input params-item" name="partsname" id="partsname" lay-search=""\n' +
            '                                            lay-filter="partsname" xm-select="partsName" xm-select-show-count="1" xm-select-skin="default" xm-select-search=""></select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">风险检查结果：</label>\n' +
            '                                <div class="layui-input-block layui-unselect layui-form-select downpanel">\n' +
            '                                    <div class="layui-select-title self-select-title ">\n' +
            '                                        <input type="text" placeholder="请选择" value="" name="riskinspectionresults"\n' +
            '                                               readonly="" class="layui-input layui-unselect params-item"\n' +
            '                                               id="search-input-riskinspectionresults">\n' +
            '                                    </div>\n' +
            '                                    <dl class="layui-anim layui-anim-upbit" style="" id="riskinspectionresults">\n' +
            '                                                      <dd><input type="checkbox" title="高" value="高" name="riskinspectionresults" lay-skin="primary">\n' +
            '                                                    </dd>\n' +
            '                                                    <dd><input type="checkbox" title="中" value="中" name="riskinspectionresults" lay-skin="primary">\n' +
            '                                                    </dd>\n' +
            '                                                    <dd><input type="checkbox" title="低" value="低" name="riskinspectionresults" lay-skin="primary">\n' +
            '                                                    </dd>\n' +
            '                                    </dl>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">PE：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <select name="responsiblepe" class="layui-input params-item" id="responsiblepe" lay-search=""\n' +
            '                                            lay-filter="responsiblepe">\n' +
            '                                    </select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">当前节点：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <select name="currentnode" class="params-item" lay-filter="currentnode" lay-search="">\n' +
            '                                        <option value="">请选择</option>\n' +
            '                                        <option value="1">待发布</option>\n' +
            '                                        <option value="2">供应商待提交文件</option>\n' +
            '                                        <option value="3">SQE待审批</option>\n' +
            '                                        <option value="4">PE待审批</option>\n' +
            '                                        <option value="5">SQE主管待审批</option>\n' +
            '                                        <option value="6">TDC平台总监待审批</option>\n' +
            '                                        <option value="7">SQE经理待审批</option>\n' +
            '                                        <option value="8">SQE总监待审批</option>\n' +
            '                                    </select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                        </div>\n' +
            '                        <div class="layui-col-md12">\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">批准状态：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <select name="approvalstatus" class="params-item" lay-filter="approvalstatus" lay-search="">\n' +
            '                                        <option value="">请选择</option>\n' +
            '                                        <option value="4">OPAP临时批准</option>\n' +
            '                                        <option value="5">OPAP不批准</option>\n' +
            '                                        <option value="2">PPAP临时批准</option>\n' +
            '                                        <option value="1">PPAP批准</option>\n' +
            '                                        <option value="3">PPAP不批准</option>\n' +
            '                                        <option value="6">正在进行中</option>\n' +
            '                                    </select>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-col-md3">\n' +
            '                                <label class="layui-form-label">最新批准计划：</label>\n' +
            '                                <div class="layui-input-block">\n' +
            '                                    <input class="layui-input" readonly placeholder="请选择" type="text"\n' +
            '                                           id="latestapprovaltime"/>\n' +
            '                                    <input class="params-item" type="hidden" name="latestapprovaltime1"/>\n' +
            '                                    <input class="params-item" type="hidden" name="latestapprovaltime2"/>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                            <div class="layui-inline layui-pull-right">\n' +
            '                                <div class="layui-inline" style="margin: 10px 6px 3px 0px;">\n' +
            '                                    <div class="layui-inline">\n' +
            '                                        <button id="btn_search" type="button" style="width: 85px;"\n' +
            '                                                class="layui-btn layui-btn-normal" lay-filter="btn_search"\n' +
            '                                                lay-submit>查询\n' +
            '                                        </button>\n' +
            '                                    </div>\n' +
            '                                    <div class="layui-inline">\n' +
            '                                        <button id="btn_reset" type="button" style="width: 85px;"\n' +
            '                                                class="layui-btn layui-btn-primary" lay-filter="btn_reset"\n' +
            '                                                lay-submit>重置\n' +
            '                                        </button>\n' +
            '                                    </div>\n' +
            '                                </div>\n' +
            '                            </div>\n' +
            '                        </div>\n' +
            '                    </div>\n'
        //查询参数对象的声明
        var requestObj = {};
        $('#search_div').append(html1)
        $('#search_div_2').show()
        formSelects.render();
        //多选框监听事件
        admin.listenMultipleSelect(linkageByProjectItem);
        // projectmodelfunc()
        //执行一个laydate实例
        laydate.render({
            elem: '#latestapprovaltime' //指定元素
            , range: true
            , done: function (value) {
                if (value) {
                    $('input[name="latestapprovaltime1"]').val(value.split(' - ')[0]);
                    $('input[name="latestapprovaltime2"]').val(value.split(' - ')[1]);
                } else {
                    $('input[name="latestapprovaltime1"]').val('');
                    $('input[name="latestapprovaltime2"]').val('');
                }
            }
        });
        /**
         * @Desc 搜索下拉面板数据获取
         * @Date 2018-12-21 17:13:08
         * @Author qitian
         */
        loadSearch = function () {
            var history = sessionStorage.getItem('requestPartsObj') ? JSON.parse(sessionStorage.getItem('requestPartsObj')) : {};
            var data = {};
            data = {suppliernumber: USER.companyCode}
            admin.req('/api-edu/ppap/partslibrary/getPartsQueryItems', data, function (res) {
                if (res.respCode == 200 && res.data) {
                    delete res.data.riskinspectionresults
                    for (var selName in res.data) {
                        $('#' + selName).empty();
                        //多选项
                        if (multipleItems.includes(selName)) {
                            admin.initMultipleSelect(selName, res.data[selName], (history && history[selName] ? history[selName] : ''));
                        } else if (newMultipleItems.includes(selName)) {
                            /* 马 2019年3月12日 11点10分  32224 零件信息维护-新增/编辑零件各字段信息，检索条件除PE外，其余条件的选项不能及时更新（需切换模块进行刷新）*/
                            var data = res.data;
                            var selectData = [];
                            var selectData1 = [];
                            var selectData2 = [];
                            var selectData3 = [];
                            var selectData4 = [];
                            var selectData5 = [];
                            if (data != null && data.suppliernum != null && data.suppliernum != undefined) {
                                for (var j = 0,length = data.suppliernum.length; j < length; j++) {
                                    var selectObj = {};
                                    selectObj.name = data.suppliernum[j];
                                    selectObj.value = data.suppliernum[j];
                                    selectData.push(selectObj);
                                }
                            }
                            if (data != null && data.suppliername != null && data.suppliername != undefined) {
                                for (var k = 0,length = data.suppliername.length; k < length; k++) {
                                    var selectObj1 = {};
                                    selectObj1.name = data.suppliername[k];
                                    selectObj1.value = data.suppliername[k];
                                    selectData1.push(selectObj1);
                                }
                            }
                            if (data != null && data.latestpartnum != null && data.latestpartnum != undefined) {
                                for (var n = 0,length = data.latestpartnum.length; n < length; n++) {
                                    var selectObj2 = {};
                                    selectObj2.name = data.latestpartnum[n];
                                    selectObj2.value = data.latestpartnum[n];
                                    selectData2.push(selectObj2);
                                }
                            }
                            if (data != null && data.partsname != null && data.partsname != undefined) {
                                for (var m = 0,length = data.partsname.length; m < length; m++) {
                                    var selectObj3 = {};
                                    selectObj3.name = data.partsname[m];
                                    selectObj3.value = data.partsname[m];
                                    selectData3.push(selectObj3);
                                }
                            }
                            if (data != null && data.itemtrackingnum != null && data.itemtrackingnum != undefined) {
                                for (var a = 0,length = data.itemtrackingnum.length; a < length; a++) {
                                    var selectObj4 = {};
                                    selectObj4.name = data.itemtrackingnum[a];
                                    selectObj4.value = data.itemtrackingnum[a];
                                    selectData4.push(selectObj4);
                                }
                            }
                            if (data != null && data.projectmodel != null && data.projectmodel != undefined) {
                                for (var b = 0,length = data.projectmodel.length; b < length; b++) {
                                    var selectObj5 = {};
                                    selectObj5.name = data.projectmodel[b];
                                    selectObj5.value = data.projectmodel[b];
                                    selectData5.push(selectObj5);
                                }
                            }
                            //formSelect-v4下拉树插件渲染
                            formSelects.data('supplierCode','local',{
                                arr: selectData
                            });
                            formSelects.btns('supplierCode',[]);
                            formSelects.data('supplierName','local',{
                                arr: selectData1
                            });
                            formSelects.btns('supplierName',[]);
                            formSelects.data('latestpartNum','local',{
                                arr: selectData2
                            });
                            formSelects.btns('latestpartNum',[]);
                            formSelects.data('partsName','local',{
                                arr: selectData3
                            });
                            formSelects.btns('partsName',[]);
                            formSelects.data('itemTrackingNum','local',{
                                arr: selectData4
                            });
                            formSelects.btns('itemTrackingNum',[]);
                            formSelects.data('projectModel','local',{
                                arr: selectData5
                            });
                            formSelects.btns('projectModel',[]);
                            /* 马 2019年3月12日 11点10分 bug修复 结束*/
                        } else {//单选项
                            if (res.data[selName].length > 0) {
                                $('#' + selName).append('<option value="">请选择</option>');
                                /*for (var item of res.data[selName]) {*/
                                for (var i = 0, len = res.data[selName].length; i < len; i++) {
                                    var item = res.data[selName][i];
                                    if (item) {
                                        if (history && history[selName] == item) {
                                            $('#' + selName).append('<option value="' + item + '" selected>' + item + '</option>');
                                        } else {
                                            $('#' + selName).append('<option value="' + item + '">' + item + '</option>');
                                        }
                                    }
                                }
                            } else {
                                $('#' + selName).append('<option value="">没有选项</option>');
                            }
                            form.render('select');
                            $('#itemtrackingnum').next().find('dd').on('click', function (e) {
                                linkageByProjectItem();
                            })
                        }

                    }
                }
            }, {
                method: 'POST'
            });
        };

        function projectmodelfunc() {
            var data = {};
            data = {suppliernumber: USER.companyCode}
            $.ajax({
                type: 'POST',
                url: admin.formatUrl('/api-edu/ppap/partslibrary/getPartsQueryItems'),
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data),
                dataType: "json",
                success: function (res) {
                    if (res.respCode == 200 && res.data) {
                        projectmodel = res.data
                        // loadDatas()
                    }
                }
            });
        }


        /**
         * @Desc 数据加载
         * @Date 2018-12-21 13:38:03
         * @Author updated by qitian
         */
        loadDatas = function () {
            //获取参数
            var sessionObj = sessionStorage.getItem('requestPartsObj') ? JSON.parse(sessionStorage.getItem('requestPartsObj')) : {};
            if ($.isEmptyObject(sessionObj)) {
                requestObj = getSearchParams();
            } else {
                var count = 0;
                for (var the in sessionObj) {
                    if (the !== 'sqe' && the != 'page' && the != 'pageSize' && sessionObj[the]) {
                        count++;
                    }
                }
                if (count === 0) {
                    requestObj = getSearchParams();
                } else {
                    requestObj = sessionObj;
                }
            }

            //除供应商以外其他角色显示列
       
                var tableCols1 = [[{fixed: 'left', type: 'checkbox'}
                    , {fixed: 'left', title: '序号', field: 'num', type: 'numbers'}
                    , {hide:true, field: 'num'}
                    , {
                        fixed: 'left',
                        field: 'alert',
                        title: '预警状态',
                        align: 'center',
                        width: 100,
                        templet: function (d) {
                            if (d.alert === 'R') {
                                //暂时不显示文字R
                                // 马 2019-03-10 bug修复 零件信息维护-【预警状态】字段UI问题 【15783】
                                // return '<div style="height: 100%;width: 100%;background-color: red">' +
                                //     '<span style="margin: 5px"></span></div>'
                                return '<div style="height: 100%;width: 100%;background-color: red">' +
                                    '<span style="margin: 5px">R</span></div>'
                                // 马 2019-03-10 bug修复 结束
                            } else if (d.alert === 'Y') {
                                //暂时不显示文字Y
                                // 马 2019-03-10 bug修复 零件信息维护-【预警状态】字段UI问题 【15783】
                                // return '<div style="height: 100%;width: 100%;background-color: yellow">' +
                                //     '<span style="margin: 5px"></span></div>'
                                return '<div style="height: 100%;width: 100%;background-color: yellow">' +
                                    '<span style="margin: 5px">Y</span></div>'
                                // 马 2019-03-10 bug修复 结束
                            } else if (d.alert === 'W') {
                                //暂时不显示文字W
                                // 马 2019-03-10 bug修复 零件信息维护-【预警状态】字段UI问题 【15783】
                                // return '<div style="height: 100%;width: 100%;">' +
                                //     '<span style="margin: 5px"></span></div>'
                                return '<div style="height: 100%;width: 100%;">' +
                                    '<span style="margin: 5px">W</span></div>'
                                // 马 2019-03-10 bug修复 结束
                            } else if (d.alert === '无') {
                                //暂时不显示文字 无计划
                                return '无计划'
                            } else {
                                return '无计划'
                            }
                        }
                    }
                    , {
                        fixed: 'left',
                        field: 'source',
                        width: '140',
                        title: '来源',
                        align: 'center',
                        templet: function (d) {
                            /** 2019年3月16日 马 修复项目车型/机型状态在数据是导入进来的时候不是可编辑状态判断 start **/
                            /*杨琴琴 2019-05-05 修改来源只要填过一次就不可更改*/
                            if(d.source != null && d.source != ''){
                                return '<div><span>'+d.source+'</span></div>'
                            }else{
                                return '<select style="width:100px" data=\'' + JSON.stringify(d) + '\' name="source" id="source_selected_' + d.LAY_TABLE_INDEX + '" onchange="tplSelected(\'source\',' + d.LAY_TABLE_INDEX + ')" lay-ignore>' +
                                    '<option value="" ' + (!d.source ? 'selected' : '') + '>-- 请选择 --</option>' +
                                    '<option value="项目阶段" ' + (d.source == '项目阶段' ? 'selected' : '') + '>项目阶段</option>' +
                                    '<option value="量产阶段(过程变更)" ' + (d.source == '量产阶段(过程变更)' ? 'selected' : '') + '>量产阶段(过程变更)</option>' +
                                    '<option value="量产阶段(EWO变更)" ' + (d.source == '量产阶段(EWO变更)' ? 'selected' : '') + '>量产阶段(EWO变更)</option>' +
                                    '<option value="量产阶段(新增供应商)" ' + (d.source == '量产阶段(新增供应商)' ? 'selected' : '') + '>量产阶段(新增供应商)</option>' +
                                    '<option value="量产阶段(其他)" ' + (d.source == '量产阶段(其他)' ? 'selected' : '') + '>量产阶段(其他)</option>' +
                                    '</select>';
                            }
                            /** 2019年3月16日 马 修复项目车型/机型状态在数据是导入进来的时候不是可编辑状态判断 end **/
                        }
                    }
                    , {
                        fixed: 'left',
                        field: 'projectmodel',
                        title: '车型/机型',
                        width: 120,
                        align: 'center',
                        templet: function (d) {
                            if(d.partsSourceFlag){
                                return '<div><span>'+d.projectmodel+'</span></div>'
                            }else{
                                return '<div style="color: #188FFF;width: 100%;height: 100%" id=\'' + JSON.stringify(d) + '\'onclick="openAll4($(this))">' + d.projectmodel + '</div>'
                            }
                        }
                    }

                    , {
                        fixed: 'left',
                        field: 'latestpartnum',
                        title: '最新零件号',
                        align: 'center',
                        edit: 'text',
                        width: 150,
                        /*杨琴琴  2019-03-11 将最新发布的零件标注为橙色*/
                        templet: function (d) {
                            var str = null;
                            if(d.newPublished == true) {//hub-002
                                str = '<div style="width: 100%;height: 100%;background-color: #FFB22C;">' + d.latestpartnum + '<i onclick="openAll(\''+ d.initialpartnum +'\' )" class="layui-icon layui-icon-list" style="font-size: 24px; color: #1E9FFF;position: absolute;right: 5px;"></i></div>';
                            }else {
                                str = '<div>' + d.latestpartnum + '<i class="layui-icon layui-icon-list" style="font-size: 24px; color: #1E9FFF;position: absolute;right: 5px;" onclick="openAll(\''+ d.initialpartnum +'\' )"></i></div>';
                            }
                            return str;
                        }
                    }
                    , {
                        fixed: 'left',
                        field: 'partsname',
                        title: '零件名称',
                        width: 160,
                        align: 'center',
                        edit: 'text',
                        templet: function (d) {
                            var str = '<a onclick="openAll1(\'' + d.partskey + '\',\'' + d.suppliernum + '\',\'' + d.partsname + '\',\'' + d.itemtrackingnum + '\',\'' + d.latestpartnum + '\',\'' + d.approvalstatus + '\')">' + d.partsname + '</a>';
                            return str;
                        }
                    }, {//updated by qitian 2019-01-24 16:13 bug编号13969
                        /*fixed: 'left',*/
                        field: 'itemtrackingnum',
                        title: '项目单编号',
                        align: 'center',
                        width: 200,
                        templet: function (d) {

                            /** 2019年3月16日  马 修复项目单编号状态在数据是导入进来的时候不是可编辑状态判断 start **/
                            if(d.partsSourceFlag){
                                return '<div><span>'+d.itemtrackingnum+'</span></div>'
                            }else{
                                return '<div id=\'' + JSON.stringify(d) + '\' style="width: 100%;height: 100%;color: #188FFF" onclick="openAll4($(this))">' + d.itemtrackingnum + '</>'
                            }

                            /** 2019年3月16日 马 修复项目单编号状态在数据是导入进来的时候不是可编辑状态判断  end **/

                        }
                    }
                    , {
                        field: 'suppliernum',
                        title: '供应商代码',
                        align: 'center',
                        width: 200,
                        // edit: 'text',
                        templet: function (d) {
                            var str = '<div id=\'' + JSON.stringify(d) + '\' style="width: 100%;height: 100%;color: #188FFF" onclick="openAll2($(this))">' + d.suppliernum + '</div>';
                            return str;
                        }
                    }
                    , {
                        field: 'suppliername', title: '供应商名称', align: 'center', width: 120,
                        // edit: 'text',
                        templet: function (d) {
                            var str = '<div id=\'' + JSON.stringify(d) + '\' style="width: 100%;height: 100%;color: #188FFF" onclick="openAll2($(this))">' + d.suppliername + '</div>';
                            return str;
                        }
                    }
                    , {
                        //updated by qitian 2019-01-25 10:27 页面bug14160
                        /* fixed: 'left',*/
                        field: 'initialpartnum',
                        title: '旧零件号',
                        align: 'center',
                        edit: 'text',
                        width: 200,
                        templet: function (d) {
                            var str = '<a>' + d.initialpartnum + '</a>';
                            return str;
                        }
                    }
                    , {
                        field: 'sqe', title: 'SQE', align: 'center', templet: function (d) {
                            var roleName = config.getAccount().roleName
                            return d.sqe;
                        }
                    }
                    /*杨琴琴 2019-05-05 零件信息维护中的风险检查结果和高风险描述只显示，不能编辑*/
                    , {field: 'riskinspectionresults', title: '风险检查结果', align: 'center', width: 140}
                    , {field: 'highriskdes', title: '高风险描述', align: 'center', width: 120}
                    , {field: 'responsiblepe', title: 'PE', width: 80, align: 'center', edit: 'text'}
                    , {
                        field: 'otsrecognitionprogram',
                        width: 120,
                        title: 'OTS认可计划',
                        align: 'center',
                        templet: function (d) {
                            /* 马 2019年3月13日 13点54分 15610 32236 零件信息维护-OTS认可计划-自动生成不可编辑 */
                            // return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.otsrecognitionprogram ? new Date(d.otsrecognitionprogram).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="otsrecognitionprogram" name="otsrecognitionprogram">'
                            //by ma 2019-03-21 15:47 【16256】
                            if (d.partsSourceFlag) {
                                return '<input disabled  readonly class="edit-laydate" style="width: 100%" value="' + (d.otsrecognitionprogram ? new Date(d.otsrecognitionprogram).Format('yyyy-MM-dd') : '') + '" placeholder="空" data=\'' + JSON.stringify(d) + '\' id="otsrecognitionprogram" name="otsrecognitionprogram">'
                            }else {
                                return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.otsrecognitionprogram ? new Date(d.otsrecognitionprogram).Format('yyyy-MM-dd') : '') + '" placeholder="空" data=\'' + JSON.stringify(d) + '\' id="otsrecognitionprogram" name="otsrecognitionprogram">'
                            }
                            /* 马 2019年3月13日 13点55分 结束 */
                        }
                    }
                    , {
                        field: 'otscompletedprogram',
                        width: 120,
                        title: 'OTS完成时间',
                        align: 'center',
                        templet: function (d) {
                            //by ma 2019-03-21 15:47 【16256】
                            if(d.partsSourceFlag) {
                                return '<input disabled readonly class="edit-laydate" style=" background-color:white; width: 100%" value="' + (d.otscompletedprogram ? new Date(d.otscompletedprogram).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="otscompletedprogram" name="otscompletedprogram">'
                            } else {
                                return '<input class="edit-laydate" style="background-color: white;width: 100%" value="' + (d.otscompletedprogram ? new Date(d.otscompletedprogram).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="otscompletedprogram" name="otscompletedprogram">'
                            }
                        }
                    }
                    , {
                        field: 'otsapprovalptatus', title: 'OTS认可状态',width: 120, align: 'center', templet: function (d) {
                            switch (d.otsapprovalptatus) {
                                case '0':
                                case 0:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">-- 请选择 --</div>';
                                case '1':
                                case 1:
                                    return '<div style="width: 100%;height: 100%;background-color: #28C935;color: black">G</div>';
                                case '2':
                                case 2:
                                    return '<div style="width: 100%;height: 100%;background-color: #FF5252;color: black">R</div>';
                                case '3':
                                case 3:
                                    return '<div style="width: 100%;height: 100%;background-color: yellow;color: black">Y</div>';
                                case '4':
                                case 4:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">W</div>';
                                case '5':
                                case 5:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">N/A</div>';
                                default:
                                    return '';
                            }
                        }}
                    , {
                        field: 'appearanceapprovalstatus', title: '外观认可状态',width: 120, align: 'center', templet: function (d) {
                            switch (d.appearanceapprovalstatus) {
                                case '0':
                                case 0:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">-- 请选择 --</div>';
                                case '1':
                                case 1:
                                    return '<div style="width: 100%;height: 100%;background-color: #28C935;color: black">G</div>';
                                case '2':
                                case 2:
                                    return '<div style="width: 100%;height: 100%;background-color: #FF5252;color: black">R</div>';
                                case '3':
                                case 3:
                                    return '<div style="width: 100%;height: 100%;background-color: yellow;color: black">Y</div>';
                                case '4':
                                case 4:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">W</div>';
                                case '5':
                                case 5:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">N/A</div>';
                                default:
                                    return '';
                            }
                        }
                    }
                    ,{
                        field: 'feapprovalstatus', title: 'FE认可状态',width: 120, align: 'center', templet: function (d) {
                            switch (d.feapprovalstatus) {
                                case '0':
                                case 0:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">-- 请选择 --</div>';
                                case '1':
                                case 1:
                                    return '<div style="width: 100%;height: 100%;background-color: #28C935;color: black">G</div>';
                                case '2':
                                case 2:
                                    return '<div style="width: 100%;height: 100%;background-color: #FF5252;color: black">R</div>';
                                case '3':
                                case 3:
                                    return '<div style="width: 100%;height: 100%;background-color: yellow;color: black">Y</div>';
                                case '4':
                                case 4:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">W</div>';
                                case '5':
                                case 5:
                                    return '<div style="width: 100%;height: 100%;background-color: white;color: black">N/A</div>';
                                default:
                                    return '';
                            }
                        }
                    }
                    , {
                        field: 'opapppapinitialapprovalplantime',
                        title: 'OPAP/PPAP初始批准计划时间',
                        width: 230,
                        templet: function (d) {
                            <!--2019-05-25 时间只要编辑过一次就不可更改-->
                            if(d.opapppapinitialapprovalplantime) {
                                return '<div>' + (d.opapppapinitialapprovalplantime ? new Date(d.opapppapinitialapprovalplantime).Format('yyyy-MM-dd') : '') + '</div>';
                            } else {
                                return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.opapppapinitialapprovalplantime ? new Date(d.opapppapinitialapprovalplantime).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="opapppapinitialapprovalplantime" name="opapppapinitialapprovalplantime">'
                            }
                        }
                    }
                    , {
                        field: 'documentsubmissionplan',
                        width: 150,
                        title: '文件提交计划',
                        align: 'center',
                        templet: function (d) {
                            return '<div>' + (d.documentsubmissionplan ? new Date(d.documentsubmissionplan).Format('yyyy-MM-dd') : '') + '</div>';
                        }
                    }
                    , {
                        field: 'pilotproductionplan',
                        width: 120,
                        title: '试生产计划',
                        align: 'center',
                        templet: function (d) {
                            return '<div>' + (d.pilotproductionplan ? new Date(d.pilotproductionplan).Format('yyyy-MM-dd') : '') + '</div>';
                        }
                    }
                    , {
                        field: 'opaplatestapprovedtime',
                        title: 'OPAP最新批准计划时间',
                        width: 200,
                        align: 'center',
                        templet: function (d) {
                            return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.opaplatestapprovedtime ? new Date(d.opaplatestapprovedtime).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="opaplatestapprovedtime" name="opaplatestapprovedtime">'
                        }
                    }
                    , {
                        field: 'ppaplatesttemporaryapprovedtime',
                        title: 'PPAP最新临时批准计划时间',
                        width: 200,
                        align: 'center',
                        templet: function (d) {
                            return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.ppaplatesttemporaryapprovedtime ? new Date(d.ppaplatesttemporaryapprovedtime).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="ppaplatesttemporaryapprovedtime" name="ppaplatesttemporaryapprovedtime">'
                        }
                    }
                    , {
                        field: 'ppaplatestapprovedtime',
                        title: 'PPAP最新批准计划时间',
                        width: 200,
                        align: 'center',
                        templet: function (d) {
                            return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.ppaplatestapprovedtime ? new Date(d.ppaplatestapprovedtime).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="ppaplatestapprovedtime" name="ppaplatestapprovedtime">'
                        }
                    }
                    , {field: 'beyondremark', title: '超期备注', width: 120, align: 'center', edit: 'text'}
                    , {field: 'changeremark', title: '计划变更时间', width: 120, align: 'center', edit: 'text'}
                    , {
                        field: 'currentnode', title: '当前节点', width: 120, align: 'center', templet: function (d) {
                            //by ma 2019/103/10 修改显示不正确
                            if (d.taskordernumber2.indexOf('PPAP') != -1) {
                                if (d.currentnode === '1') {
                                    return '<div>待发布</div>'
                                } else if (d.currentnode === '2') {
                                    return '<div>供应商文件待提交</div>'
                                } else if (d.currentnode === '3') {
                                    return '<div>SQE待审批</div>'
                                } else if (d.currentnode === '4') {
                                    return '<div>SQE主管待审批</div>'
                                } else if (d.currentnode === '5') {
                                    return '<div>SQE经理待审批</div>'
                                } else if (d.currentnode === '6') {
                                    return '<div>SQE总监待审批</div>'
                                } else if (d.currentnode === '7') {
                                    return '<div>审批完成</div>'
                                } else {
                                    return ''
                                }
                            } else {
                                if (d.currentnode === '1') {
                                    return '<div>待发布</div>'
                                } else if (d.currentnode === '2') {
                                    return '<div>PE待审批</div>'
                                } else if (d.currentnode === '3') {
                                    return '<div>SQE经理待审批</div>'
                                } else if (d.currentnode === '4') {
                                    return '<div>TDC平台总工待审批</div>'
                                } else if (d.currentnode === '5') {
                                    return '<div>SQE总监待审批</div>'
                                } else if (d.currentnode === '6') {
                                    return '<div>审批完成</div>'
                                } else {
                                    return ''
                                }
                            }

                        }
                    }
                    , {
                        field: 'approvalstatus', title: '批准状态', width: 120, align: 'center', templet: function (d) {
                            if (d.approvalstatus === '4') {
                                return '<div>OPAP临时批准</div>'
                            } else if (d.approvalstatus === '5') {
                                return '<div>OPAP不批准</div>'
                            } else if (d.approvalstatus === '2') {
                                return '<div>PPAP临时批准</div>'
                            } else if (d.approvalstatus === '1') {
                                return '<div>PPAP批准</div>'
                            } else if (d.approvalstatus === '3') {
                                return '<div>PPAP不批准</div>'
                            } else if (d.approvalstatus === '6') {
                                return '<div>正在进行中</div>'
                            } else {
                                return ''
                            }
                        }
                    }
                    , {field: 'approvedver', title: '批准版本号', width: 120, align: 'center'}
                    , {field: 'latestewo', title: '最新EWO', width: 120, align: 'center', edit: 'text'}
                    , {
                        field: 'latestapprovaltime',
                        title: '最新批准时间',
                        width: 150,
                        align: 'center',
                        templet: function (d) {
                            return '<div>' + (d.latestapprovaltime ? new Date(d.latestapprovaltime).Format('yyyy-MM-dd') : '') + '</div>';
                        }
                    }
                    , {
                        field: 'provisionalapprovaldate', title: '有效期', width: 80, align: 'center', templet: function (d) {
                            return '<div>' + (d.provisionalapprovaldate ? new Date(d.provisionalapprovaldate).Format('yyyy-MM-dd') : '') + '</div>'
                        }
                    }
                    , {field: 'provisionalapprovalwhy', title: '临时批准原因', width: 150, align: 'center'}
                    , {
                        field: 'firstapprovaltime',
                        title: '首次批准时间',
                        width: 150,
                        align: 'center',
                        templet: function (d) {
                            return '<div>' + (d.firstapprovaltime ? new Date(d.firstapprovaltime).Format('yyyy-MM-dd') : '') + '</div>';
                        }
                    }
                    , {field: 'updatetime', title: '更新时间', width: 100, align: 'center'}
                    , {field: 'updateperson', title: '更新人', width: 80, align: 'center'}
                    , {
                        field: 'taskordernumber', title: '任务单编号', width: 120, width: 300, templet: function (d) {
                            var str = ''
                            if (d.taskordernumber.indexOf(',') != -1) {
                                var list = d.taskordernumber.split(',');
                                if (list.length > 0) {
                                    str = '<a onclick=\'openAlla(' + JSON.stringify(d) + ')\'>';
                                    str += list[0]
                                    str += '&nbsp;&nbsp;&nbsp;&nbsp;<img src="../../assets/images/加号.png" height="32" width="32"/>' + '</a>';
                                }
                                return str;
                            } else {
                                return '<a href="#" onclick=\'jumpTaskOrderPage('+ JSON.stringify(d) +')\'>' + d.taskordernumber + '</a>';
                            }
                        }
                    }
                ]];
            //供应商显示列
            var tableCols2 = [[{fixed: 'left', type: 'checkbox'}
                , {fixed: 'left', title: '序号', field: 'num', type: 'numbers', width: 60}
                , {
                    fixed: 'left', field: 'alert', title: '预警状态', width: 100, align: 'center', templet: function (d) {
                        if (d.alert === 'R') {
                            //暂时不显示文字R
                            // 马 2019-03-10 bug修复 零件信息维护-【预警状态】字段UI问题 【15783】
                            // return '<div style="height: 100%;width: 100%;background-color: red">' +
                            //     '<span style="margin: 5px"></span></div>'
                            return '<div style="height: 100%;width: 100%;background-color: red">' +
                                '<span style="margin: 5px">R</span></div>'
                            // 马 2019-03-10 bug修复 结束
                        } else if (d.alert === 'Y') {
                            //暂时不显示文字Y
                            // 马 2019-03-10 bug修复 零件信息维护-【预警状态】字段UI问题 【15783】
                            // return '<div style="height: 100%;width: 100%;background-color: yellow">' +
                            //     '<span style="margin: 5px"></span></div>'
                            return '<div style="height: 100%;width: 100%;background-color: yellow">' +
                                '<span style="margin: 5px">Y</span></div>'
                            // 马 2019-03-10 bug修复 结束
                        } else if (d.alert === 'W') {
                            //暂时不显示文字W
                            // 马 2019-03-10 bug修复 零件信息维护-【预警状态】字段UI问题 【15783】
                            // return '<div style="height: 100%;width: 100%;">' +
                            //     '<span style="margin: 5px"></span></div>'
                            return '<div style="height: 100%;width: 100%;">' +
                                '<span style="margin: 5px">W</span></div>'
                            // 马 2019-03-10 bug修复 结束
                        } else if (d.alert === '无') {
                            //暂时不显示文字 无计划
                            return '无计划'
                        } else {
                            return '无计划'
                        }
                    }
                }
                , {fixed: 'left', field: 'source', width: '120', title: '来源', align: 'center'}
                , {fixed: 'left', field: 'projectmodel', width: 120, title: '车型/机型', align: 'center'}
                , {fixed: 'left', field: 'latestpartnum', title: '最新零件号', width: 150, align: 'center'}
                , {fixed: 'left', field: 'partsname', title: '零件名称', width: 160, align: 'center'}
                // wangxiahui 2019-01-31 bug 31487
                , {field: 'sqe', title: 'SQE', width: 60, align: 'center'}
                //updated by qitian 2019-01-24 16:13 bug编号13969
                , {field: 'itemtrackingnum', width: 190, title: '项目单编号', align: 'center'}
                // , {field: 'suppliernum', title: '供应商代码', align: 'center'}
                // , {field: 'suppliername', title: '供应商名称', align: 'center'}
                , {field: 'initialpartnum', title: '旧零件号', width: 120, align: 'center'}
                , {field: 'riskinspectionresults', title: '风险检查结果', width: 150, align: 'center'}
                , {field: 'highriskdes', title: '高风险描述', width: 120, align: 'center'}
                , {field: 'responsiblepe', title: 'PE', width: 80, align: 'center'}
                , {
                    field: 'otsrecognitionprogram',
                    title: 'OTS认可计划',
                    width: 150,
                    align: 'center',
                    templet: function (d) {
                        return '<div>' + (d.otsrecognitionprogram ? new Date(d.otsrecognitionprogram).Format('yyyy-MM-dd') : '') + '</div>';
                    }
                }
                , {
                    field: 'otscompletedprogram', title: 'OTS完成时间', width: 150, align: 'center', templet: function (d) {
                        return '<div>' + (d.otscompletedprogram ? new Date(d.otscompletedprogram).Format('yyyy-MM-dd') : '') + '</div>';
                    }
                }
                , {
                    field: 'otsapprovalptatus', title: 'OTS认可状态',width: 120, align: 'center', templet: function (d) {
                        switch (d.otsapprovalptatus) {
                            case '0':
                            case 0:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">-- 请选择 --</div>';
                            case '1':
                            case 1:
                                return '<div style="width: 100%;height: 100%;background-color: #28C935;color: black">G</div>';
                            case '2':
                            case 2:
                                return '<div style="width: 100%;height: 100%;background-color: #FF5252;color: black">R</div>';
                            case '3':
                            case 3:
                                return '<div style="width: 100%;height: 100%;background-color: yellow;color: black">Y</div>';
                            case '4':
                            case 4:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">W</div>';
                            case '5':
                            case 5:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">N/A</div>';
                            default:
                                return '';
                        }
                    }
                }
                , {
                    field: 'appearanceapprovalstatus', title: '外观认可状态',width: 120, align: 'center', templet: function (d) {
                        switch (d.appearanceapprovalstatus) {
                            case '0':
                            case 0:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">-- 请选择 --</div>';
                            case '1':
                            case 1:
                                return '<div style="width: 100%;height: 100%;background-color: #28C935;color: black">G</div>';
                            case '2':
                            case 2:
                                return '<div style="width: 100%;height: 100%;background-color: #FF5252;color: black">R</div>';
                            case '3':
                            case 3:
                                return '<div style="width: 100%;height: 100%;background-color: yellow;color: black">Y</div>';
                            case '4':
                            case 4:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">W</div>';
                            case '5':
                            case 5:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">N/A</div>';
                            default:
                                return '';
                        }
                    }
                }
                , {
                    field: 'feapprovalstatus', title: 'FE认可状态',width: 120, align: 'center', templet: function (d) {
                        switch (d.feapprovalstatus) {
                            case '0':
                            case 0:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">-- 请选择 --</div>';
                            case '1':
                            case 1:
                                return '<div style="width: 100%;height: 100%;background-color: #28C935;color: black">G</div>';
                            case '2':
                            case 2:
                                return '<div style="width: 100%;height: 100%;background-color: #FF5252;color: black">R</div>';
                            case '3':
                            case 3:
                                return '<div style="width: 100%;height: 100%;background-color: yellow;color: black">Y</div>';
                            case '4':
                            case 4:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">W</div>';
                            case '5':
                            case 5:
                                return '<div style="width: 100%;height: 100%;background-color: white;color: black">N/A</div>';
                            default:
                                return '';
                        }
                    }
                }
                , {field: 'opapppapinitialapprovalplantime', width: 230, title: 'OPAP/PPAP初始批准计划时间',
                    templet: function (d) {
                        <!--杨琴琴 2019-05-25 修改供应商端时间不可编辑-->
                        return '<div>' + (d.opapppapinitialapprovalplantime ? new Date(d.opapppapinitialapprovalplantime).Format('yyyy-MM-dd') : '') + '</div>';// 马 2019-03-10 修改OPAP/PPAP初始批准计划时间显示 【15709】
//                        return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.opapppapinitialapprovalplantime ? new Date(d.opapppapinitialapprovalplantime).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="opapppapinitialapprovalplantime" name="opapppapinitialapprovalplantime">'

                    }}
                , {
                    field: 'documentsubmissionplan',
                    title: '文件提交计划',
                    width: 120,
                    align: 'center',
                    templet: function (d) {
                        return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.documentsubmissionplan ? new Date(d.documentsubmissionplan).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="documentsubmissionplan" name="documentsubmissionplan">'
                    }
                }
                , {
                    field: 'pilotproductionplan', title: '试生产计划', width: 120, align: 'center', templet: function (d) {
                        return '<input readonly class="edit-laydate" style="width: 100%" value="' + (d.pilotproductionplan ? new Date(d.pilotproductionplan).Format('yyyy-MM-dd') : '') + '" placeholder="请选择" data=\'' + JSON.stringify(d) + '\' id="pilotproductionplan" name="pilotproductionplan">'
                    }
                }
                , {
                    field: 'opaplatestapprovedtime',
                    title: 'OPAP最新批准计划时间',
                    width: 200,
                    align: 'center',
                    templet: function (d) {
                        return '<div>' + (d.opaplatestapprovedtime ? new Date(d.opaplatestapprovedtime).Format('yyyy-MM-dd') : '') + '</div>';
                    }
                }
                , {
                    field: 'ppaplatesttemporaryapprovedtime',
                    title: 'PPAP最新临时批准计划时间',
                    width: 200,
                    align: 'center',
                    templet: function (d) {
                        return '<div>' + (d.ppaplatesttemporaryapprovedtime ? new Date(d.ppaplatesttemporaryapprovedtime).Format('yyyy-MM-dd') : '') + '</div>';
                    }
                }
                , {
                    field: 'ppaplatestapprovedtime',
                    title: 'PPAP最新批准计划时间',
                    width: 200,
                    align: 'center',
                    templet: function (d) {
                        return '<div>' + (d.ppaplatestapprovedtime ? new Date(d.ppaplatestapprovedtime).Format('yyyy-MM-dd') : '') + '</div>';
                    }
                }
                , {field: 'beyondremark', title: '超期备注', width: 120, align: 'center'}
                , {field: 'changeremark', title: '计划变更时间', width: 120, align: 'center'}
                , {
                    field: 'currentnode', title: '当前节点', width: 120, align: 'center'
                    , templet: function (d) {
                        if (d.taskordernumber2.indexOf('PPAP') != -1) {
                            if (d.currentnode === '1') {
                                return '<div>待发布</div>'
                            } else if (d.currentnode === '2') {
                                return '<div>供应商文件待提交</div>'
                            } else if (d.currentnode === '3') {
                                return '<div>SQE待审批</div>'
                            } else if (d.currentnode === '4') {
                                return '<div>SQE主管待审批</div>'
                            } else if (d.currentnode === '5') {
                                return '<div>SQE经理待审批</div>'
                            } else if (d.currentnode === '6') {
                                return '<div>SQE总监待审批</div>'
                            } else if (d.currentnode === '7') {
                                return '<div>审批完成</div>'
                            } else {
                                return ''
                            }
                        } else {
                            if (d.currentnode === '1') {
                                return '<div>待发布</div>'
                            } else if (d.currentnode === '2') {
                                return '<div>PE待审批</div>'
                            } else if (d.currentnode === '3') {
                                return '<div>SQE经理待审批</div>'
                            } else if (d.currentnode === '4') {
                                return '<div>TDC平台总工待审批</div>'
                            } else if (d.currentnode === '5') {
                                return '<div>SQE总监待审批</div>'
                            } else if (d.currentnode === '6') {
                                return '<div>审批完成</div>'
                            } else {
                                return ''
                            }
                        }

                    }
                }
                , {
                    field: 'approvalstatus', title: '批准状态', width: 120, align: 'center', templet: function (d) {
                        if (d.approvalstatus === '4') {
                            return '<div>OPAP临时批准</div>'
                        } else if (d.approvalstatus === '5') {
                            return '<div>OPAP不批准</div>'
                        } else if (d.approvalstatus === '2') {
                            return '<div>PPAP临时批准</div>'
                        } else if (d.approvalstatus === '1') {
                            return '<div>PPAP批准</div>'
                        } else if (d.approvalstatus === '3') {
                            return '<div>PPAP不批准</div>'
                        } else if (d.approvalstatus === '6') {
                            return '<div>正在进行中</div>'
                        } else {
                            return ''
                        }
                    }
                }
                , {field: 'approvedver', title: '批准版本号', width: 120, align: 'center'}
                , {field: 'latestewo', title: '最新EWO', width: 120, align: 'center'}
                , {
                    field: 'latestapprovaltime', title: '最新批准时间', width: 120, align: 'center', templet: function (d) {
                        return '<div>' + (d.latestapprovaltime ? new Date(d.latestapprovaltime).Format('yyyy-MM-dd') : '') + '</div>';
                    }
                }
                , {
                    field: 'provisionalapprovaldate', title: '有效期', width: 120, align: 'center', templet: function (d) {
                        return '<div>' + (d.provisionalapprovaldate ? new Date(d.provisionalapprovaldate).Format('yyyy-MM-dd') : '') + '</div>'
                    }
                }
                , {field: 'provisionalapprovalwhy', width: 120, title: '临时批准原因', align: 'center'}
                , {
                    field: 'firstapprovaltime', width: 120, title: '首次批准时间', align: 'center', templet: function (d) {
                        return '<div>' + (d.firstapprovaltime ? new Date(d.firstapprovaltime).Format('yyyy-MM-dd') : '') + '</div>';
                    }
                }
                , {field: 'updatetime', width: 100, title: '更新时间', align: 'center'}
                , {field: 'updateperson', width: 80, title: '更新人', align: 'center'}
                , {
                    field: 'taskordernumber', title: '任务单编号', width: 200, align: 'center',
                    /**马 2019-3-13 13:50 bug修复 零件信息管理[含两个子模块]-供应商登录-任务单编号没有超链接 【15711】**/
                    templet: function (d) {
                        var str = ''
                        if (d.taskordernumber.indexOf(',') != -1) {
                            var list = d.taskordernumber.split(',');
                            if (list.length > 0) {
                                str = '<a onclick=\'openAlla(' + JSON.stringify(d) + ')\'>';
                                str += list[0]
                                str += '&nbsp;&nbsp;&nbsp;&nbsp;<img src="../../assets/images/加号.png" height="32" width="32"/>' + '</a>';
                            }
                            return str;
                        } else {
                            return '<a href="#" onclick=\'jumpTaskOrderPage('+ JSON.stringify(d) +')\'>' + d.taskordernumber + '</a>';
                        }
                    }
                    /**马 2019-3-13 13:50 bug修复 结束**/
                }
            ]];
            // 渲染表格
            //这是供应商的页面，永远是供应商，不存在判断
            requestObj.suppliernum = USER.companyCode;
            tableInit = table.render({
                elem: '#parts-manage-table',
                method: 'post',
                id: 'parts-manage-table',
                url: admin.formatUrl('/api-edu/ppap/partslibrary/searchByMessagesComrade'),// 马 2019-3-12 10:51 bug修复  零件信息维护-SQE主管新增零件，默认SQE显示主管自己 【15618】PPAP流程-PPAP批准-零件又重新回到零件信息库中【15728】
                // 格式化后台返回的数据
                parseData: function (res) { //res 即为原始返回的数据
                    // 返回结果，进行渲染表格
                    console.log(USER)
                    if (res.respCode != -1) {
                        sessionStorage.setItem('requestPartsObj', JSON.stringify(requestObj));
                        if (res.data.page) {
                            // for (var item of res.data.page) {
                            for (var i = 0, len = res.data.page.length; i < len; i++) {
                                var item = res.data.page[i];
                                item.documentsubmissionplan = item.documentsubmissionplan ? new Date(item.documentsubmissionplan).Format('yyyy-MM-dd') : '';
                                item.pilotproductionplan = item.pilotproductionplan ? new Date(item.pilotproductionplan).Format('yyyy-MM-dd') : '';
                                item.updatetime = item.updatetime ? new Date(item.updatetime).Format('yyyy-MM-dd hh:mm:ss') : '';
                                item.otsrecognitionprogram = item.otsrecognitionprogram ? new Date(item.otsrecognitionprogram).Format('yyyy-MM-dd') : '';
                                item.otscompletedprogram = item.otscompletedprogram ? new Date(item.otscompletedprogram).Format('yyyy-MM-dd') : ''
                            }
                        }
                    }
                    return {
                        "code": res.respCode != -1 ? 0 : -1, //解析接口状态
                        "msg": res.respCode == -1 ? '暂无数据' : '', //解析提示文本
                        "count": res.data && res.data.count ? res.data.count : 0, //解析数据长度
                        "data": res.data && res.data.page ? admin.redefinedForObject(res.data.page) : [] //解析数据列表
                    };
                },
                height: 'full-405',
                cols:tableCols2, 
                cellMinWidth: 90,
                page: {
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                },
                limits: [10, 50, 100],
                request: {
                    pageName: 'page',
                    limitName: 'pageSize'
                },
                where: requestObj,
                done: function (res, curr, count) {
                    //2019/02/21 liuhuiwen
                    var dev_obj; //layui table 父div
                    var layuitable = null; //当前的layui table
                    dev_obj = document.getElementById('table_div'); //table的父div,名字替换成相对应的
                    if (dev_obj != null) {
                        layuitable = dev_obj.getElementsByClassName("layui-table-main");
                    }
                    console.log(dev_obj, layuitable, sessionStorage["scrollleft" + 'table_div'])
                    if (res.data.length != 0) {
                        //updated by qitian 2019-01-22
                        setTimeout(function () {
                            ///by ma 2019-3-27
                            //更改滚动条位置
                            layuitable[0].scrollLeft = sessionStorage["scrollleft" + 'table_div'];
                            $('.layui-table-box').css('overflow-x', 'hidden');
                            $('.layui-table-header').css('overflow', 'hidden');
                            $(window).resize();
                        },1);

                        $('.edit-laydate').each(function (index, item) {
                            laydate.render({
                                elem: this,
                                done: function (value) {
                                    debugger;
                                    console.info('value'+value);
                                        var obj = JSON.parse($(item).attr('data'));
                                        var itemName = $(item).attr('name');
                                        obj[itemName] = value;
                                        saveItemRequest(obj);
                                }
                            })
                        })
                    }
                }});
            showThcolor();
        };

        //搜索功能中 下拉框 内容加载
        loadSearch();
        // 初始化，执行一次渲染表格
        loadDatas();

        // DONE: 侧边栏变化时刷新数据表格
        // 将 table ID 存入数组
        layui.adc.addTableCache('parts-manage-table');

        /**
         * @Desc 表头颜色
         * @Date 2018-12-23 17:23:45
         * @Author qitian
         */
        function showThcolor() {
            $('.table-round th[data-field =\'0\']').css("background-color", "#C8E0F0");
            $('.table-round th[data-field =\'num\']').css("background-color", "#C8E0F0");
            //wangxiahui 2019-01-31 bug 31487
            //$('.table-round th[data-field =\'sqe\']').css("background-color", "#C8E0F0");
            $('.table-round th[data-field =\'alert\']').css("background-color", "#C8E0F0");
            $('.table-round th[data-field =\'source\']').css("background-color", "#C8E0F0");
            $('.table-round th[data-field =\'projectmodel\']').css("background-color", "#C8E0F0");
            //updated by qitian 2019-01-24 16:13 bug编号13969
            //$('.table-round th[data-field =\'itemtrackingnum\']').css("background-color", "#C8E0F0");
            $('.table-round th[data-field =\'latestpartnum\']').css("background-color", "#C8E0F0");
            $('.table-round th[data-field =\'partsname\']').css("background-color", "#C8E0F0");

        }

        /**
         * @Desc 即时保存
         * @Date 2018-12-21 21:37:52
         * @Author qitian
         */
        table.on('edit(parts-manage-table)', function (obj) {
            //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
            /*console.log(obj.value); //得到修改后的值
            console.log(obj.field); //当前编辑的字段名
            console.log(obj.data); //所在行的所有相关数据*/
            // 当修改的列为最新零件号（latestpartnum）时，和修改供应商的逻辑一致
            if('latestpartnum' ==  obj.field) {
                // 因为和修改供应商的逻辑一致，在此处使用updateSupplierNumberFlag字段
                obj.updateSupplierNumberFlag = true;
            }
            delete obj.data.updatetime;
            // if (obj.data.approvalstatus == 6) {
            //     layer.msg('正在进行中，不可编辑！', {
            //         icon: 5
            //     });
            //     loadDatas();
            //     return;
            // }
            //updated by qitian 2019-02-01 初始零件号和最新零件号长度不能超过15位
            if ((obj.field == 'latestpartnum' || obj.field == 'initialpartnum') && obj.value.length > 15) {
                layer.alert('此项的输入长度不可超过15位！',{
                    icon: 5
                    ,btn:['关闭']
                });
                loadDatas();
                return false;
            }
            // 张大伟 2019-3-27 客户最新需求，对项目车型不做校验【如果把这个校验关闭掉无法对比大项目名称因此还需要打开2019-4-1】
            if (obj.field === 'projectmodel' && obj.value.indexOf('-') === -1) {
                layer.alert('此项必须存在英文中划线符号(-)，且不能位于首尾位置', {
                    icon: 5
                    ,btn:['关闭']
                })
                return false;
            }
            //yuzhong 修改如果最新和初始零件有问题，那么就清数据
            saveItemRequest(obj.data,null,obj);
        });

        /**
         * @Desc 搜索按钮
         * @Date 2018-12-21 20:30:32
         * @Author qitian
         */
        form.on('submit(btn_search)', function () {
            sessionStorage.removeItem('requestPartsObj')
            loadDatas();
        });
        /**
         * @Desc 重置按钮
         * @Date 2018-12-21 20:30:32
         * @Author qitian
         */
        form.on('submit(btn_reset)', function () {
            // 马 2019-03-11 bug修复 零件信息维护-按照最新零件号筛选，勾选几个查询，删除一个零件后，没有刷新出整个列表 【15932】
//             $('.params-item').each(function (index, item) {
//                 //2019-02-16  注释，原因BUG号14330
// //                if (item.name != 'sqe') {
//                     $(item).val('');
// //                }
//             });
//             form.render('select', 'search-form-content');
//             //多选框重置
//             admin.resetMultipleSelect('.searcher-panel');
//             $('#latestapprovaltime').val('');
//             $('#itemtrackingnum').val('');
//             //重新渲染所有联动的多选
//             //重新渲染所有联动的多选
//             formSelects.value('supplierCode', []);
//             formSelects.value('supplierName', []);
//             formSelects.value('latestpartNum', []);
//             formSelects.value('partsName', []);
//             formSelects.value('itemTrackingNum', []);
//             formSelects.value('projectModel', []);
//
//
//             requestObj = {};
//             $('#btn_search').click();
//             //updated by qitina 2019-01-24 17:00 bug编号14104
//             $('#linkage-projectmodel').val('');
//             $('#linkage-itemtrackingnum').val('');
//             $('#linkage-ots1').val('');
//             $('#linkage-ots2').val('');
//             $('#linkage-ns').val('');
//             $('#linkage-stime').val('');
//             $('#linkage-soptime').val('');
            resetDatas();
            // 马 2019-03-11 bug修复 结束
        });

        // 马 2019-03-11 bug修复 零件信息维护-按照最新零件号筛选，勾选几个查询，删除一个零件后，没有刷新出整个列表 【15932】
        function resetDatas() {
            $('.params-item').each(function (index, item) {
                $(item).val('');
            });
            form.render('select', 'search-form-content');
            //多选框重置
            admin.resetMultipleSelect('.searcher-panel');
            $('#latestapprovaltime').val('');
            $('#itemtrackingnum').val('');
            //重新渲染所有联动的多选
            //重新渲染所有联动的多选
            formSelects.value('supplierCode', []);
            formSelects.value('supplierName', []);
            formSelects.value('latestpartNum', []);
            formSelects.value('partsName', []);
            formSelects.value('itemTrackingNum', []);
            formSelects.value('projectModel', []);

            requestObj = {};
            $('#btn_search').click();
            //updated by qitina 2019-01-24 17:00 bug编号14104
            $('#linkage-projectmodel').val('');
            $('#linkage-itemtrackingnum').val('');
            $('#linkage-ots1').val('');
            $('#linkage-ots2').val('');
            $('#linkage-ns').val('');
            $('#linkage-stime').val('');
            $('#linkage-soptime').val('');
        }
        // 马 2019-03-11 bug修复 结束
        /**
         * 重置表单内容
         */
        function resetForm(resetItems) {
            for (var i = 0; i < resetItems.length; i++) {
                var item = $("#" + resetItems[i]);
                switch (item.prop("tagName")) {
                    case "INPUT":
                    case "SELECT":
                        item.val("");
                        break;
                    case "DL":
                        item.empty();
                        break;
                }
            }
            $(".layui-anim.layui-anim-upbit input:checkbox").prop("checked", false);
        }
        var can = true;
        /**
         * @Desc 导出总清单按钮
         * @Date 2018-12-21 14:36:54
         * @Author qitian
         */
        form.on('submit(exportAllPart)', function () {
            var reqObj = {}; //查询参数对象的赋值
            reqObj = sessionStorage.getItem('requestPartsObj') ? JSON.parse(sessionStorage.getItem('requestPartsObj')) : {};
            reqObj.exportTp = "eidt";
            //结束
            admin.req('/api-edu/ppap/partslibrary/getExportPartslibrary', reqObj, function (data) {
                if (data.respCode != -1) {
                    window.location = admin.formatUrl('/api-edu/ppap/partslibrary/exportgPartslibrary?saveCode=' + data.message);
                }
            }, {
                method: 'POST'
            });
        });

        /**
         * @Desc 搜索下拉面板---全选按钮
         * @Date 2018-12-21 17:42:58
         * @Author qitian
         */
        form.on('checkbox(chooseAllPeroson)', function (obj) {
            console.log(obj)
            var itemName = $(obj.elem).attr('name');
            var checkStatus = $('input[name="' + itemName + '"]');
            if ($(obj.elem).next().hasClass('layui-form-checked')) {
                $('input[name="' + itemName + '"]').val('请选择');//获取历史选中的所有值
                checkStatus.each(function (index, item) {
                    $(item).next().addClass('layui-form-checked')
                })
            } else {
                $('input[name="' + itemName + '"]').val('');
                checkStatus.each(function (index, item) {
                    $(item).next().removeClass('layui-form-checked')
                })
            }
        })

        // 弹出框取消按钮
        form.on('submit(cancel-delete)', function () {
            admin.closePopupCenter();
            loadDatas();
        });

        //删除零件模态框确定按钮事件
        form.on('submit(submit-delete)', function () {
            if ($('#delete-reason').val()) {
                admin.req('/api-edu/ppap/partslibrary/deletePart', {
                    partskey: $('#delete-partskey').val(),
                    latestpartnum: $('#delete-latestpartnum').val(),
                    suppliernum: $('#delete-suppliernum').val(),
                    deletereason: $('#delete-reason').val(),
                    sqe: USER.userId,
                    sqeName : USER.userName,
                    roleName : USER.roleName
                }, function (data) {
                    if (data.respCode != -1) {
                        layer.alert(data.message, {
                            icon: 1
                            ,btn:['关闭']
                        });
                        admin.closePopupCenter();
                        // 马 2019-03-11 bug修复 零件信息维护-按照最新零件号筛选，勾选几个查询，删除一个零件后，没有刷新出整个列表 【15932】
//                             loadDatas();
//                             loadSearch();
//                             $.ajax({
// //            url: admin.formatUrl('/api-edu/risk/analysis/supplierCode'),
//                                 url: admin.formatUrl('/api-edu/ppap/partslibrary/getPartsQueryItems'),
//                                 type: 'POST',
//                                 contentType: 'application/json; charset=utf-8',
//                                 data: JSON.stringify(dataFirst),
//                                 dataType: "json",
//                                 success: function success(res) {
//                                     /*var data = res.data;
//                                     $("#gysdm1").empty();
//                                     var queGpSelect = "<option value=''>请选择供应商代码</option>";
//                                     $.each(data, function (i, n) {
//                                         queGpSelect += "<option value='" + n.suppliercode + "'>" + n.suppliercode + "</option>";
//                                     });
//                                     $("#gysdm1").html(queGpSelect);
//                                     $("#gysdm2").html(queGpSelect);
//                                     form.render('select');*/
//                                     var data = res.data;
//                                     var selectData = [];
//                                     var selectData1 = [];
//                                     var selectData2 = [];
//                                     var selectData3 = [];
//                                     var selectData4 = [];
//                                     var selectData5 = [];
//                                     if (data != null && data.suppliernum != null && data.suppliernum != undefined) {
//                                         for (var j = 0,length = data.suppliernum.length; j < length; j++) {
//                                             var selectObj = {};
//                                             selectObj.name = data.suppliernum[j];
//                                             selectObj.value = data.suppliernum[j];
//                                             selectData.push(selectObj);
//                                         }
//                                     }
//                                     if (data != null && data.suppliername != null && data.suppliername != undefined) {
//                                         for (var k = 0,length = data.suppliername.length; k < length; k++) {
//                                             var selectObj1 = {};
//                                             selectObj1.name = data.suppliername[k];
//                                             selectObj1.value = data.suppliername[k];
//                                             selectData1.push(selectObj1);
//                                         }
//                                     }
//                                     if (data != null && data.latestpartnum != null && data.latestpartnum != undefined) {
//                                         for (var n = 0,length = data.latestpartnum.length; n < length; n++) {
//                                             var selectObj2 = {};
//                                             selectObj2.name = data.latestpartnum[n];
//                                             selectObj2.value = data.latestpartnum[n];
//                                             selectData2.push(selectObj2);
//                                         }
//                                     }
//                                     if (data != null && data.partsname != null && data.partsname != undefined) {
//                                         for (var m = 0,length = data.partsname.length; m < length; m++) {
//                                             var selectObj3 = {};
//                                             selectObj3.name = data.partsname[m];
//                                             selectObj3.value = data.partsname[m];
//                                             selectData3.push(selectObj3);
//                                         }
//                                     }
//                                     if (data != null && data.itemtrackingnum != null && data.itemtrackingnum != undefined) {
//                                         for (var a = 0,length = data.itemtrackingnum.length; a < length; a++) {
//                                             var selectObj4 = {};
//                                             selectObj4.name = data.itemtrackingnum[a];
//                                             selectObj4.value = data.itemtrackingnum[a];
//                                             selectData4.push(selectObj4);
//                                         }
//                                     }
//                                     if (data != null && data.projectmodel != null && data.projectmodel != undefined) {
//                                         for (var b = 0,length = data.projectmodel.length; b < length; b++) {
//                                             var selectObj5 = {};
//                                             selectObj5.name = data.projectmodel[b];
//                                             selectObj5.value = data.projectmodel[b];
//                                             selectData5.push(selectObj5);
//                                         }
//                                     }
//                                     //formSelect-v4下拉树插件渲染
//                                     formSelects.data('supplierCode','local',{
//                                         arr: selectData
//                                     });
//                                     formSelects.btns('supplierCode',[]);
//                                     formSelects.data('supplierName','local',{
//                                         arr: selectData1
//                                     });
//                                     formSelects.btns('supplierName',[]);
//                                     formSelects.data('latestpartNum','local',{
//                                         arr: selectData2
//                                     });
//                                     formSelects.btns('latestpartNum',[]);
//                                     formSelects.data('partsName','local',{
//                                         arr: selectData3
//                                     });
//                                     formSelects.btns('partsName',[]);
//                                     formSelects.data('itemTrackingNum','local',{
//                                         arr: selectData4
//                                     });
//                                     formSelects.btns('itemTrackingNum',[]);
//                                     formSelects.data('projectModel','local',{
//                                         arr: selectData5
//                                     });
//                                     formSelects.btns('projectModel',[]);
//                                 }
//                             });
                        //马 2019-03-27 零件维护删除后头部搜索不重置，只刷新表格 bug【16327】
                        tableInit.reload('parts-manage-table');
//                            resetDatas();
                        // 马 2019-03-11 bug修复 结束
                    } else {
                        layer.alert(data.message, {
                            icon: 5
                            ,btn:['关闭']
                        });
                    }
                }, {
                    method: 'POST'
                });
            } else {
                layer.alert('请填写删除原因！', {
                    icon: 5
                    ,btn:['关闭']
                })
            }

        });

        //填写备注模态框提交事件submit-remark-save
        form.on('submit(submit-remark-save)', function () {
            if ($('#save-remark').val() && $('#save-obj').attr('data')) {
                var obj = JSON.parse($('#save-obj').attr('data'));
                if ($('#show-label').html() === '超期备注') {
                    obj.beyondremark = $('#save-remark').val();
                } else {
                    obj.changeremark = $('#save-remark').val();
                }
                saveItemRequest(obj, 1);
            } else {
                layer.alert('请填写超期备注！', {
                    icon: 5
                    ,btn:['关闭']
                })
            }

        });


        /**
         * @Desc 获取查询参数
         * @Param
         * @Date 2018-12-23 14:27:11
         * @Author qitian
         */
        function getSearchParams() {
            //置空查询参数
            var _requestObj = JSON.parse(JSON.stringify(requestObj));
            $('.params-item').each(function (index, item) {
                var name = $(item).attr('name');
                var thisId = $(item).attr('id');
                var value = $(item).val();
                if (name != "" && name != null) {
                    //下拉框联动不进入 循环结束进行特殊处理
                    if (multipleItems.includes(name)) {
                        if (value == '请选择') {
                            //_requestObj[name] = '';
                        } else {
                            if (value) {
                                _requestObj[name] = value;
                            } else if (_requestObj[name]) {
                                delete _requestObj[name]
                            }
                        }
                    } else {
                        if (name == 'sqe' || name == 'latestapprovaltime1' || name == 'latestapprovaltime2') {
                            if (value) {
                                _requestObj[name] = value;
                            } else if (_requestObj[name]) {
                                delete _requestObj[name]
                            }
                        } else {
                            form.on('select(' + name + ')', function (obj) {
                                if (obj.value) {
                                    _requestObj[name] = obj.value
                                } else if (_requestObj[name]) {
                                    delete _requestObj[name]
                                }
                            });
                        }

                    }
                } else {
                    //进行下拉框联动的 取值部分 123456789
                    //name为空 是下拉框联动
                    if (thisId == "itemtrackingnum") {
                        //项目单编号
                        var selectValue = layui.formSelects.value('itemTrackingNum', 'valStr');
                        console.log(selectValue);
                        if (selectValue == '请选择') {
                            //_requestObj[name] = '';
                        } else {
                            if (selectValue) {
                                _requestObj['itemtrackingnum'] = selectValue;
                            } else if (_requestObj['itemtrackingnum']) {
                                delete _requestObj['itemtrackingnum']
                            }
                        }
                    } else if (thisId == "search-input-projectmodel") {
                        //项目车型/机型：
                        var selectValue = layui.formSelects.value('projectModel', 'valStr');
                        console.log(selectValue);
                        if (selectValue == '请选择') {
                            //_requestObj[name] = '';
                        } else {
                            if (selectValue) {
                                _requestObj['projectmodel'] = selectValue;
                            } else if (_requestObj['projectmodel']) {
                                delete _requestObj['projectmodel']
                            }
                        }
                    } else if (thisId == "latestpartnum") {
                        //最新零件号：
                        var selectValue = layui.formSelects.value('latestpartNum', 'valStr');
                        console.log(selectValue);
                        if (selectValue == '请选择') {
                            //_requestObj[name] = '';
                        } else {
                            if (selectValue) {
                                _requestObj['latestpartnum'] = selectValue;
                            } else if (_requestObj['latestpartnum']) {
                                delete _requestObj['latestpartnum']
                            }
                        }
                    } else if (thisId == "partsname") {
                        //零件名称：
                        var selectValue = layui.formSelects.value('partsName', 'valStr');
                        console.log(selectValue);
                        if (selectValue == '请选择') {
                            //_requestObj[name] = '';
                        } else {
                            if (selectValue) {
                                _requestObj['partsname'] = selectValue;
                            } else if (_requestObj['partsname']) {
                                delete _requestObj['partsname']
                            }
                        }
                    } else if (thisId == "suppliernum") {
                        //供应商代码：
                        var selectValue = layui.formSelects.value('supplierCode', 'valStr');
                        console.log(selectValue);
                        if (selectValue == '请选择') {
                            //_requestObj[name] = '';
                        } else {
                            if (selectValue) {
                                _requestObj['suppliernum'] = selectValue;
                            } else if (_requestObj['suppliernum']) {
                                delete _requestObj['suppliernum']
                            }
                        }
                    } else if (thisId == "search-input-suppliername") {
                        //供应商名称：
                        var selectValue = layui.formSelects.value('supplierName', 'valStr');
                        console.log(selectValue);
                        if (selectValue == '请选择') {
                            //_requestObj[name] = '';
                        } else {
                            if (selectValue) {
                                _requestObj['suppliername'] = selectValue;
                            } else if (_requestObj['suppliername']) {
                                delete _requestObj['suppliername']
                            }
                        }
                    }
                }

            });
            return _requestObj;
        }

        form.on('select(suppliernum1)', function (data) {
            console.log(data.elem); //得到select原始DOM对象
            console.log(data.value); //得到被选中的值
            console.log(data.othis); //得到美化后的DOM对象
            console.log(selectdata1)
            dataobj2.suppliernum = data.value
            //根据供应商代码查询名称
            admin.req('/api-edu/ppap/edum05user/getSupplierIdByCode', {companycode: data.value}, function (res) {
                if (res.respCode == 200) {
                    if (data.value == '') {
                        $('#suppliername1').val('')
                    } else {
                        $('#suppliername1').val(res.data.companyname)
                    }
                    dataobj2.suppliername = res.data.companyname

                    form.render('select')
                } else {
                    layer.alert(res.message, {
                        icon: 5
                        ,btn:['关闭']
                    });
                }
            }, {method: 'GET'})
        });
        form.on('select(suppliername1)', function (data) {
            console.log(data.elem); //得到select原始DOM对象
            console.log(data.value); //得到被选中的值
            console.log(data.othis); //得到美化后的DOM对象
            console.log(selectdata1)
            dataobj2.suppliername = data.value

            //根据供应商名称查询代码
            admin.req('/api-edu/ppap/edum05user/getSupplierIdByCode', {companyname: data.value}, function (res) {
                if (res.respCode == 200) {
                    if (data.value == '') {
                        $('#suppliernum1').val('')
                    } else {
                        $('#suppliernum1').val(res.data.companycode)
                    }
                    dataobj2.suppliernum = res.data.companycode

                    form.render('select')
                } else {
                    layer.alert(res.message, {
                        icon: 5
                        ,btn:['关闭']
                    });
                }
            }, {method: 'GET'})
        });
        form.on('select(latestpartnum1)', function (data) {
            selectdata2.latestpartnum = data.value
            //根据最新零件编号查询零件名称
            var searchdata = {
                sqe: config.getAccount().userId,
                latestpartnum: data.value
            }
            $.ajax({
                type: 'POST',
                url: admin.formatUrl('/api-edu/ppap/partslibrary/searchByMessagesHjj'),// 马 2019-3-12 10:54 bug修复  零件信息维护-SQE主管新增零件，默认SQE显示主管自己 【15618】PPAP流程-PPAP批准-零件又重新回到零件信息库中【15728】
                data: searchdata,
                dataType: "json",
                success: function (res) {
                    if (res.respCode == 200) {
                        if (res.data.page.length != 0) {
                            if (data.value == '') {
                                $('#partsname1').val('')
                            } else {
                                $('#partsname1').val(res.data.page[0].partsname)
                            }
                            selectdata2.partsname = res.data.page[0].partsname
                            form.render('select')
                        }
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        });
                    }
                }
            });
        });
        form.on('select(partsname1)', function (data) {
            selectdata2.partsname = data.value
            //根据零件名称查询最新零件编号
            var searchdata = {
                sqe: config.getAccount().userId,
                partsname: data.value
            }
            $.ajax({
                type: 'POST',
                url: admin.formatUrl('/api-edu/ppap/partslibrary/searchByMessagesHjj'),// 马 2019-3-12 10:54 bug修复  零件信息维护-SQE主管新增零件，默认SQE显示主管自己 【15618】PPAP流程-PPAP批准-零件又重新回到零件信息库中【15728】
                data: searchdata,
                dataType: "json",
                success: function (res) {
                    if (res.respCode == 200) {
                        if (res.data.page.length != 0) {
                            if (data.value == '') {
                                $('#latestpartnum1').val('')
                            } else {
                                $('#latestpartnum1').val(res.data.page[0].latestpartnum)
                            }
                            selectdata2.latestpartnum = res.data.page[0].latestpartnum
                            form.render('select')
                        }
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        });
                    }
                }
            });
        });
        form.on('select(sqe1)', function (data) {
            console.log(data.elem); //得到select原始DOM对象
            console.log(data.value); //得到被选中的值
            console.log(data.othis); //得到美化后的DOM对象
            console.log(selectdata3)
            selectdata3.sqe = data.value
        });
        form.on('select(itemtrackingnum1)', function (data) {
            console.log(data.elem); //得到select原始DOM对象
            console.log(data.value); //得到被选中的值
            console.log(data.othis); //得到美化后的DOM对象
            console.log(selectdata4)
            thisdata.itemtrackingnum = data.value

            var searchdata = {
                itemtrackingnum: data.value
            }
            $.ajax({
                type: 'POST',
                url: admin.formatUrl('/api-edu/ppap/partslibrary/searchByMessagesHjj'), // 马 2019-3-12 10:54 bug修复  零件信息维护-SQE主管新增零件，默认SQE显示主管自己 【15618】PPAP流程-PPAP批准-零件又重新回到零件信息库中【15728】
                data: searchdata,
                dataType: "json",
                success: function (res) {
                    if (res.respCode == 200) {
                        if (res.data.page.length != 0) {
                            if (data.value == '') {
                                $('#projectmodelChange').val('')
                            } else {
                                $('#projectmodelChange').val(res.data.page[0].projectmodel)
                            }
                            thisdata.projectmodel = res.data.page[0].projectmodel
                            form.render('select')
                            /**马 2019-3-12 20:10 bug修复 【15615】**/
                            setTimeout(function () {
                                $('#select_input input').attr('id', 'searchinput1')
                                $('#program_input input').attr('id', 'programinput1')
                                $('#select_input input').attr('onblur', 'resetinput1()')
                            }, 1);
                            /**马 2019-3-12 20:10 bug修复 结束**/
                        }
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        });
                    }
                }
            });
        });
        form.on('select(projectmodelChange)', function (data) {
            console.log(data.elem); //得到select原始DOM对象
            console.log(data.value); //得到被选中的值
            console.log(data.othis); //得到美化后的DOM对象
            thisdata.projectmodel = data.value

            var searchdata = {
                projectmodel: data.value
            }
            $.ajax({
                type: 'POST',
                url: admin.formatUrl('/api-edu/ppap/partslibrary/searchByMessagesHjj'),// 马 2019-3-12 10:54 bug修复  零件信息维护-SQE主管新增零件，默认SQE显示主管自己 【15618】PPAP流程-PPAP批准-零件又重新回到零件信息库中【15728】
                data: searchdata,
                dataType: "json",
                success: function (res) {
                    if (res.respCode == 200) {
                        if (res.data.page.length != 0) {
                            if (data.value == '') {
                                $('#itemtrackingnum1').val('')
                            } else {
                                $('#itemtrackingnum1').val(res.data.page[0].itemtrackingnum)
                            }
                            thisdata.itemtrackingnum = res.data.page[0].itemtrackingnum
                            form.render('select')
                            /**马 2019-3-12 20:10 bug修复 【15615】**/
                            setTimeout(function () {
                                $('#select_input input').attr('id', 'searchinput1')
                                $('#program_input input').attr('id', 'programinput1')
                                $('#select_input input').attr('onblur', 'resetinput1()')
                            }, 1);
                            /**马 2019-3-12 20:10 bug修复 结束**/
                        }
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        });
                    }
                }
            });
        });


        /**
         * @Desc 供应商代码与供应商名称的联动
         */
        var dataFirst = {};
        //是供应商的页面，无需判断其它
        dataFirst = {suppliernumber: USER.companyCode}
        $.ajax({
//            url: admin.formatUrl('/api-edu/risk/analysis/supplierCode'),
            url: admin.formatUrl('/api-edu/ppap/partslibrary/getPartsQueryItems'),
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(dataFirst),
            dataType: "json",
            success: function success(res) {
                /*var data = res.data;
                $("#gysdm1").empty();
                var queGpSelect = "<option value=''>请选择供应商代码</option>";
                $.each(data, function (i, n) {
                    queGpSelect += "<option value='" + n.suppliercode + "'>" + n.suppliercode + "</option>";
                });
                $("#gysdm1").html(queGpSelect);
                $("#gysdm2").html(queGpSelect);
                form.render('select');*/
                var data = res.data;
                var selectData = [];
                var selectData1 = [];
                var selectData2 = [];
                var selectData3 = [];
                var selectData4 = [];
                var selectData5 = [];
                if (data != null && data.suppliernum != null && data.suppliernum != undefined) {
                    for (var j = 0,length = data.suppliernum.length; j < length; j++) {
                        var selectObj = {};
                        selectObj.name = data.suppliernum[j];
                        selectObj.value = data.suppliernum[j];
                        selectData.push(selectObj);
                    }
                }
                if (data != null && data.suppliername != null && data.suppliername != undefined) {
                    for (var k = 0,length = data.suppliername.length; k < length; k++) {
                        var selectObj1 = {};
                        selectObj1.name = data.suppliername[k];
                        selectObj1.value = data.suppliername[k];
                        selectData1.push(selectObj1);
                    }
                }
                if (data != null && data.latestpartnum != null && data.latestpartnum != undefined) {
                    for (var n = 0,length = data.latestpartnum.length; n < length; n++) {
                        var selectObj2 = {};
                        selectObj2.name = data.latestpartnum[n];
                        selectObj2.value = data.latestpartnum[n];
                        selectData2.push(selectObj2);
                    }
                }
                if (data != null && data.partsname != null && data.partsname != undefined) {
                    for (var m = 0,length = data.partsname.length; m < length; m++) {
                        var selectObj3 = {};
                        selectObj3.name = data.partsname[m];
                        selectObj3.value = data.partsname[m];
                        selectData3.push(selectObj3);
                    }
                }
                if (data != null && data.itemtrackingnum != null && data.itemtrackingnum != undefined) {
                    for (var a = 0,length = data.itemtrackingnum.length; a < length; a++) {
                        var selectObj4 = {};
                        selectObj4.name = data.itemtrackingnum[a];
                        selectObj4.value = data.itemtrackingnum[a];
                        selectData4.push(selectObj4);
                    }
                }
                if (data != null && data.projectmodel != null && data.projectmodel != undefined) {
                    for (var b = 0,length = data.projectmodel.length; b < length; b++) {
                        var selectObj5 = {};
                        selectObj5.name = data.projectmodel[b];
                        selectObj5.value = data.projectmodel[b];
                        selectData5.push(selectObj5);
                    }
                }
                //formSelect-v4下拉树插件渲染
                formSelects.data('supplierCode','local',{
                    arr: selectData
                });
                formSelects.btns('supplierCode',[]);
                formSelects.data('supplierName','local',{
                    arr: selectData1
                });
                formSelects.btns('supplierName',[]);
                formSelects.data('latestpartNum','local',{
                    arr: selectData2
                });
                formSelects.btns('latestpartNum',[]);
                formSelects.data('partsName','local',{
                    arr: selectData3
                });
                formSelects.btns('partsName',[]);
                formSelects.data('itemTrackingNum','local',{
                    arr: selectData4
                });
                formSelects.btns('itemTrackingNum',[]);
                formSelects.data('projectModel','local',{
                    arr: selectData5
                });
                formSelects.btns('projectModel',[]);
            }
        });
        //根据供应商代码查询供应商名称
        formSelects.on('supplierCode',function (id, vals, val, isAdd, isDisabled) {
            //id:                   点击select的id
            //vals:                 当前select已选中的值
            //val:                  当前select点击的值
            //isAdd:                当前操作选择中or取消
            //isDisabled:          当前选项是否是disabled
            //如果return false则取消本次操作
            admin.req("/api-edu/ppap/partslibrary/selectSuppliernameBySuppliernumber?supplierNumber=" + val.value, {}, function (res) {
                var data = res.data;
                if(data&& data.length>0){
                    if (isAdd) {
                        layui.formSelects.value('supplierName', [data], true);
                    } else {
                        layui.formSelects.value('supplierName', [data], false);
                    }
                }
            });
        });
        formSelects.filter('supplierCode', function(id, inputVal, val, isDisabled){
            if(
                val.name.indexOf(inputVal) != -1                                //文本是否包含
            ){
                return false;
            }
            return true;
        });
        //根据供应商名称查询供应商代码
        formSelects.on('supplierName',function (id, vals, val, isAdd, isDisabled) {
            //id:                   点击select的id
            //vals:                 当前select已选中的值
            //val:                  当前select点击的值
            //isAdd:                当前操作选择中or取消
            //isDisabled:          当前选项是否是disabled
            //如果return false则取消本次操作
            admin.req("/api-edu/ppap/partslibrary/selectSuppliernumberBySuppliername?supplierName=" + val.value, {}, function (res) {
                var data = res.data;
                if(data&& data.length>0){
                    if (isAdd) {
                        layui.formSelects.value('supplierCode', [data], true);
                    } else {
                        layui.formSelects.value('supplierCode', [data], false);
                    }
                }
            });
        });
        formSelects.filter('supplierName', function(id, inputVal, val, isDisabled){
            if(
                val.name.indexOf(inputVal) != -1                                //文本是否包含
            ){
                return false;
            }
            return true;
        });

        //根据最新零件编号查询零件名称    /api-edu/ppap/partslibrary/selectPartsNameByLatestpartNum?latestpartNum=" + val.value,
        formSelects.on('latestpartNum',function (id, vals, val, isAdd, isDisabled) {
            //id:                   点击select的id
            //vals:                 当前select已选中的值
            //val:                  当前select点击的值
            //isAdd:                当前操作选择中or取消
            //isDisabled:          当前选项是否是disabled
            //如果return false则取消本次操作
            admin.req("/api-edu/ppap/partslibrary/selectPartsNameByLatestpartNum?latestpartNum=" + val.value, {}, function (res) {
                var data = res.data;
                if(data&& data.length>0){
                    if (isAdd) {
                        layui.formSelects.value('partsName', data, true);//2019-04-10 huangbin修改
                    } else {
                        layui.formSelects.value('partsName', data, false);//2019-04-10 huangbin修改
                    }
                }
            });
        });
        formSelects.filter('latestpartNum', function(id, inputVal, val, isDisabled){
            if(
                val.name.indexOf(inputVal) != -1                                //文本是否包含
            ){
                return false;
            }
            return true;
        });
        //根据零件名称查询最新零件编号    /api-edu/ppap/partslibrary/selectLatestpartNumByPartsName?partsName=" + val.value
        formSelects.on('partsName',function (id, vals, val, isAdd, isDisabled) {
            //id:                   点击select的id
            //vals:                 当前select已选中的值
            //val:                  当前select点击的值
            //isAdd:                当前操作选择中or取消
            //isDisabled:          当前选项是否是disabled
            //如果return false则取消本次操作
            admin.req("/api-edu/ppap/partslibrary/selectLatestpartNumByPartsName?partsName=" + val.value, {}, function (res) {
                var data = res.data;
                if(data&& data.length>0){
                    if (isAdd) {
                        layui.formSelects.value('latestpartNum', data, true);//2019-04-10 huangbin修改
                    } else {
                        layui.formSelects.value('latestpartNum', data, false);//2019-04-10 huangbin修改
                    }
                }
            });
        });
        formSelects.filter('partsName', function(id, inputVal, val, isDisabled){
            if(
                val.name.indexOf(inputVal) != -1                                //文本是否包含
            ){
                return false;
            }
            return true;
        });



        //根据项目单编号查询项目车型机型
        formSelects.on('itemTrackingNum',function (id, vals, val, isAdd, isDisabled) {
            //id:                   点击select的id
            //vals:                 当前select已选中的值
            //val:                  当前select点击的值
            //isAdd:                当前操作选择中or取消
            //isDisabled:          当前选项是否是disabled
            //如果return false则取消本次操作
            var selectLength = vals.length;
            admin.req("/api-edu/ppap/partslibrary/queryProjectmodelByItemtrackingnum?queryItemtrackingnums=" + val.value, {}, function (res) {
                var data = res.data;
                if(data&& data.length>0){
                    if (isAdd) {
                        layui.formSelects.value('projectModel', [data], true);
                        //要选中
                        //如果vals是0说明该次选中是第一次选中   加载根据项目单编号的联动
                        if (selectLength === 0) {
                            linkageByProjectItem(val.value, 0);
                        } else {
                            linkageByProjectItem("", 3);
                        }
                    } else {
                        layui.formSelects.value('projectModel', [data], false);
                        //要取消
                        //如果vals是2说明项目单编号要取消，取消后的剩余一个   加载根据项目单编号的联动
                        if (selectLength === 2) {
                            for (var a = 0; a < 2;a++){
                                if (vals[a].value != val.value) {
                                    //剩余的一个 说明vals[a].value是取消后剩下的那个
                                    linkageByProjectItem(vals[a].value,0);
                                }
                            }
                        } else {
                            linkageByProjectItem("", 3);
                        }
                    }
                }
            });
        });
        formSelects.filter('itemTrackingNum', function(id, inputVal, val, isDisabled){
            if(
                val.name.indexOf(inputVal) != -1                                //文本是否包含
            ){
                return false;
            }
            return true;
        });
        //根据项目车型机型查询项目单编号
        formSelects.on('projectModel',function (id, vals, val, isAdd, isDisabled) {
            //id:                   点击select的id
            //vals:                 当前select已选中的值
            //val:                  当前select点击的值
            //isAdd:                当前操作选择中or取消
            //isDisabled:          当前选项是否是disabled
            //如果return false则取消本次操作
            var selectLength = vals.length;
            admin.req("/api-edu/ppap/partslibrary/queryItemtrackingnumByProjectmodel?projectmodels=" + val.value, {}, function (res) {
                var data = res.data;
                if(data&& data.length>0){
                    if (isAdd) {
                        layui.formSelects.value('itemTrackingNum', [data], true);
                        //要选中
                        //如果vals是0说明该次选中是第一次选中   加载根据项目单编号的联动
                        if (selectLength === 0) {
                            linkageByProjectItem(val.value, 1);
                        } else {
                            linkageByProjectItem("", 3);
                        }
                    } else {
                        layui.formSelects.value('itemTrackingNum', [data], false);
                        //要取消
                        //如果vals是2说明项目单编号要取消，取消后的剩余一个   加载根据项目单编号的联动
                        if (selectLength === 2) {
                            for (var a = 0; a < 2;a++){
                                if (vals[a].value != val.value) {
                                    //剩余的一个 说明vals[a].value是取消后剩下的那个
                                    linkageByProjectItem(vals[a].value,1);
                                }
                            }
                        } else {
                            linkageByProjectItem("", 3);
                        }
                    }
                }
            });
        });
        formSelects.filter('projectModel', function(id, inputVal, val, isDisabled){
            if(
                val.name.indexOf(inputVal) != -1                                //文本是否包含
            ){
                return false;
            }
            return true;
        });

    });

    /**
     * @Desc 可编辑表格中的下拉选择监听事件
     * @Param itemName 元素name;index:表格索引
     * @Date 2018-12-21 21:40:16
     * @Author qitian
     */
    function tplSelected(itemName, index) {
        var admin = layui.adc;
        if (itemName) {
            var obj = JSON.parse($('#' + itemName + '_selected_' + index + '').attr('data'));
            if (itemName != 'source') {
                obj[itemName] = $('#' + itemName + '_selected_' + index + '').val();
            } else {
                obj[itemName] = $('.layui-table-fixed #' + itemName + '_selected_' + index + '').val();
            }
            // if (obj.approvalstatus == 6) {
            //     layer.msg('正在进行中，不可编辑！', {
            //         icon: 5
            //     });
            //     loadDatas();
            //     return;
            // }
            saveItemRequest(obj);
        }
    }

    /**
     * @Desc 可编辑表格中的下拉选择监听事件（高风险下拉）
     * @Param itemName 元素name;index:表格索引
     * @Date 2018-12-21 21:40:16
     * @Author qitian
     */
    function tplSelected1(itemName, index) {
        var admin = layui.adc;
        if (itemName) {
            var obj = JSON.parse($('#' + itemName + '_selected_' + index + '').attr('data'));
            if (itemName != 'source') {
                obj[itemName] = $('#' + itemName + '_selected_' + index + '').val();
            } else {
                obj[itemName] = $('.layui-table-fixed #' + itemName + '_selected_' + index + '').val();
            }
            // if (obj.approvalstatus == 6) {
            //     layer.msg('正在进行中，不可编辑！', {
            //         icon: 5
            //     });
            //     loadDatas();
            //     return;
            // }
            if (obj.riskinspectionresults != '高') {
                saveItemRequest(obj);
            } else {
                var html = ''
                html += '<div class="layui-form" style="padding-top: 30px"><div class="layui-row"><label class="layui-form-label">高风险描述：</label>\n' +
                    '                    <div class="layui-input-block">\n' +
                    '                        <input class="layui-input" id="highriskdes"></div></div>' +
                    '</div>'
                layer.open({
                    type: 1
                    , title: '更多'
                    , area: ['550px', '200px']//设置模态框宽度
                    , content: html
                    , btn: ['保存', '关闭']
                    , closeBtn: 0
                    , yes: function (index, layero) {
                        var config = layui.config;
                        obj.updateperson = config.getAccount().userName;
                        obj.highriskdes = $('#highriskdes').val();
                        delete obj.responsiblepe;
                        delete obj.updatetime;
                        //马    将highriskdes和escalationriskdes字段合为一个 2019-03-17
                        var highriskdes = obj.highriskdes;
                        obj.escalationriskdes = highriskdes;
                        //按钮【按钮二】的回调
                        admin.req('/api-edu/ppap/partslibrary/savePart', obj, function (res) {
                            if (res.respCode == 200) {
                                layer.close(index);
                                // by ma 2019-04-10
                                layui.table.reload('parts-manage-table', {
                                });
                                // loadDatas();
                            } else {
                                layer.alert(res.message, {
                                    icon: 5
                                    ,btn:['关闭']
                                })
                            }
                        }, {method: 'POST'})
                    }, btn2: function (index, layero) {
                        layer.close(index);
                        loadDatas();
                    }
                });
            }
        }
    }

    /**
     * @Desc 即时保存请求
     * @Param obj: 请求参数对象;isModel:是否为模态框请求，是的话需要关闭模态框
     * @Date 2018-12-22 16:42:19
     * @Author qitian
     */
    function saveItemRequest(obj, isModel,obj2) {
        // if (obj.approvalstatus == 6) {
        //     layer.msg('正在进行中，不可编辑！', {
        //         icon: 5
        //     });
        //     return;
        // }
        var admin = layui.adc
            , config = layui.config
            , table = layui.table;
        obj.sqe = config.getAccount().userId;
        obj.updateperson = config.getAccount().userName;
        if (!obj.responsiblepe) {
            delete obj.responsiblepe;
            delete obj.updatetime;
        }
        //马    将highriskdes和escalationriskdes字段合为一个 2019-03-17
        var highriskdes = obj.highriskdes;
        obj.escalationriskdes = highriskdes;
        admin.req('/api-edu/ppap/partslibrary/updateParts', obj, function (res) {
            if (res.respCode == 200) {
                if (isModel) {
                    $('#is-save').val('1');
                    //2019-01-01注释，原因保存成功不需要提示信息
                    /*layer.msg(res.message,{
                    icon: 1
                })*/
                    admin.closePopupCenter();
                } else {
                    //更新搜索面板下拉数据
                    loadSearch();
                }
                //更新表格数据
//                    loadDatas();
                table.reload('parts-manage-table', {
                });

            } else {
                table.reload('parts-manage-table', {
                });
                layer.alert(res.message, {
                    icon: 5
                    ,btn:['关闭']
                })
                //yuzhong 如果初始零件和最新零件有问题，那么就把数据清掉
                if(obj2){
                    if(res.message === '最新零件号已存在'){
                        obj2.data.latestpartnum = ''
                        obj2.update(obj2.data);
                    }
                    if(res.message === '旧零件号已存在' || res.message === '对应的最新零件号不存在'){
                        obj2.data.initialpartnum = ''
                        obj2.update(obj2.data);
                    }
                }
            }
        }, {method: 'POST'})
    }

    /**
     * @Desc 根据项目单编号联动
     * @Date 2018-12-21 20:55:34
     * @Author qitian
     */
    function linkageByProjectItem(values, num) {
        var form = layui.form,
            admin = layui.adc;
        //num 用于确定是从那个进行调用的0是对项目单编号进行操作调用的1是对项目车型机型进行操作进行调用的
        var itemtrackingnum = "";
        var projectmodel = "";
        if (num === 0) {
            itemtrackingnum = values;
            projectmodel = layui.formSelects.value('projectModel', 'valStr');
        } else if (num === 1) {
            itemtrackingnum = layui.formSelects.value('itemTrackingNum', 'valStr');
            projectmodel = values;
        }
        if (itemtrackingnum || projectmodel) {
            var data = {
                itemtrackingnum: itemtrackingnum,
                projectmodel: projectmodel
            }
            admin.req('/api-edu/ppap/partslibrary/linkageByProjectItem', data, function (res) {
                if (res.respCode == 200 && res.data && res.data.length === 1) {
                    //赋值
                    if (res.data[0].projecttype == '1') {
                        $('#linkage-ots1').parent().prev().html('OTS1：');
                        $('#linkage-ots2').parent().prev().html('OTS2：');
                        $('#linkage-ns').parent().prev().html('NS：');
                        $('#linkage-stime').parent().prev().html('S：');
                    } else if (res.data[0].projecttype == '2') {
                        $('#linkage-ots1').parent().prev().html('BETA：');
                        $('#linkage-ots2').parent().prev().html('GAMMA：');
                        $('#linkage-ns').parent().prev().html('3C Pilot：');
                        $('#linkage-stime').parent().prev().html('Pilot：');
                    }
                    $('#linkage-itemtrackingnum').val(res.data[0].pfollowcode);
                    $('#linkage-projectmodel').val(res.data[0].pcartype);
                    $('#linkage-ots1').val(res.data[0].ots1 ? new Date(res.data[0].ots1).Format('yyyy-MM-dd') : '');
                    $('#linkage-ots2').val(res.data[0].ots2 ? new Date(res.data[0].ots2).Format('yyyy-MM-dd') : '');
                    $('#linkage-ns').val(res.data[0].ns ? new Date(res.data[0].ns).Format('yyyy-MM-dd') : '');
                    $('#linkage-stime').val(res.data[0].stime ? new Date(res.data[0].stime).Format('yyyy-MM-dd') : '');
                    $('#linkage-soptime').val(res.data[0].soptime ? new Date(res.data[0].soptime).Format('yyyy-MM-dd') : '');
                } else {
                    $('#linkage-itemtrackingnum').val('');
                    $('#linkage-projectmodel').val('');
                    $('#linkage-ots1').val('');
                    $('#linkage-ots2').val('');
                    $('#linkage-ns').val('');
                    $('#linkage-stime').val('');
                    $('#linkage-soptime').val('');
                }
            }, {
                method: 'POST'
            })
        } else {
            $('#linkage-itemtrackingnum').val('');
            $('#linkage-projectmodel').val('');
            $('#linkage-ots1').val('');
            $('#linkage-ots2').val('');
            $('#linkage-ns').val('');
            $('#linkage-stime').val('');
            $('#linkage-soptime').val('');
        }


    }

    /**
     * @Desc 搜索面板伸缩
     * @Date 2018-12-21 14:29:06
     * @Author qitian
     */
    function flexSearcherPanel() {
        //现状态为收起
        if ($('.searcher-panel').hasClass('layui-hide')) {
            $('.searcher-panel').removeClass('layui-hide');
            $('#searcher-div-close').removeClass('layui-hide');
            $('#searcher-div-open').addClass('layui-hide');
        } else {
            $('.searcher-panel').addClass('layui-hide');
            $('#searcher-div-close').addClass('layui-hide');
            $('#searcher-div-open').removeClass('layui-hide');
        }
    }

    //显示
    function openAll(initialpartnum) {
        var admin = layui.adc;
        var data = {
            initialpartnum: initialpartnum
        }
        admin.req('/api-edu/ppap/partslibrary/getPartsInfo', data, function (res) {
            if (res.respCode == 200) {
                if(res.data.length == 0){
                    layer.alert("无数据")
                    return
                }
                var data = admin.redefinedForObject(res.data)
                var html = '<table class="layui-table" style="width: 980px !important;margin-left: 10px !important;">';
                for (var i = 0; i < data.length; i++) {
                    if (data[i].approvalstatus === '4') {
                        data[i].approvalstatus = 'OPAP临时批准';
                    } else if (data[i].approvalstatus === '5') {
                        data[i].approvalstatus = 'OPAP不批准';
                    } else if (data[i].approvalstatus === '2') {
                        data[i].approvalstatus = 'PPAP临时批准';
                    } else if (data[i].approvalstatus === '1') {
                        data[i].approvalstatus = 'PPAP批准';
                    } else if (data[i].approvalstatus === '3') {
                        data[i].approvalstatus = 'PPAP不批准';
                    } else if (data[i].approvalstatus === '6') {
                        data[i].approvalstatus = '正在进行中';
                    } else {
                        data[i].approvalstatus = '';
                    }
                    //by ma 2019-03-21 【16217】
                    if(data[i].approvedver ==''){
                        data[i].approvedver = '00'
                    }
                    html += '<tr>' +
                        '<td width="46px">零件号:</td>' +
                        '<td>' + data[i].latestpartnum + '</td>' +
                        '<td width="74px">任务单号:</td>' +
                        '<td>' + data[i].taskordernumber + '</td>' +
                        '<td width="32px">时间:</td>' +
                        '<td>' + (data[i].updatetime ? new Date(data[i].updatetime).Format('yyyy-MM-dd') : '') + '</td>' +
                        '<td width="60px">批准状态:</td>' +
                        '<td>' + data[i].approvalstatus  + '</td>' +
                        '<td width="32px">版本:</td>' +
                        '<td>' + data[i].approvedver + '</td>' +
                        '<td width="60px">批准时间:</td>' +
                        '<td>' + (data[i].latestapprovaltime ? new Date(data[i].latestapprovaltime).Format('yyyy-MM-dd') : '无') + '</td>' +
                        '</tr>'
                }
                html += '</table>'
                layer.open({
                    type: 1
                    , title: '更多'
                    , area: ['1000px', '400px']//设置模态框宽度
                    , content: '' + html + ''
                    , btn: ['关闭']
                    , yes: function (index, layero) {
                        //按钮【按钮二】的回调
                        layer.close(index);
                    }
                });
            } else {
                layer.alert(res.message, {
                    icon: 5
                    ,btn:['关闭']
                })
            }
        }, {method: 'POST'})
    }

    //供应商代码和供应商名称联动
    var selectdata1 = {};
    var dataobj2

    function openAll2($this) {
        var form = layui.form,
            config = layui.config,
            admin = layui.adc;

        dataobj2 = JSON.parse($this[0].id)

        var oldSuppliernum = dataobj2.suppliernum

        if (dataobj2.approvalstatus == 6) {
            layer.alert('正在进行中，不可编辑！', {
                icon: 5
                ,btn:['关闭']
            });
            return;
        }
        var html = '';
        html += '<div class="layui-form" style="padding-top: 10px"><div class="layui-row"><label class="layui-form-label">供应商代码：</label>\n' +
            '                    <div id="select_input1"  class="layui-input-block">\n' +
            '                        <select class="layui-form-select" name="suppliernum1" id="suppliernum1"\n' +
            '                    lay-filter="suppliernum1" lay-search=""></select>\n' +
            '                        </div></div>' +
            '<div class="layui-row"><label class="layui-form-label">供应商名称：</label>' +
            '                    <div id="select_input2"  class="layui-input-block">' +
            '                        <select class="layui-form-select" name="suppliername1" id="suppliername1"' +
            '                    lay-filter="suppliername1" lay-search=""></select>' +
            '                        </div></div></div>'
        var data = {};
        //供应商页面，无需判断其它
         data = {suppliernumber: USER.companyCode}
        admin.req('/api-edu/ppap/edum05user/getSupplierInfoAll', {}, function (res) {
                if (res.respCode == 200 && res.data) {
                    $('#suppliernum1').empty()
                    $('#suppliername1').empty()
                    $('#suppliernum1').append('<option value="">请选择</option>')
                    for (var i = 0; i < res.data.length; i++) {
                        if (dataobj2.suppliernum == res.data[i].supplierCode) {
                            $('#suppliernum1').append('<option selected="selected">' + res.data[i].supplierCode + '</option>')
                        } else {
                            $('#suppliernum1').append('<option>' + res.data[i].supplierCode + '</option>')
                        }
                    }
                    // setTimeout(function () {
                    //     $('#select_input1 input').attr('id','searchinput1')
                    //     $('#select_input1 input').attr('onblur','resetinput1()')
                    // }, 1);
                    $('#suppliername1').append('<option value="">请选择</option>')
                    for (var i = 0; i < res.data.length; i++) {
                        if (dataobj2.suppliername == res.data[i].supplierName) {
                            $('#suppliername1').append('<option selected="selected">' + res.data[i].supplierName + '</option>')
                        } else {
                            $('#suppliername1').append('<option>' + res.data[i].supplierName + '</option>')
                        }
                    }
                    // setTimeout(function () {
                    //     $('#select_input2 input').attr('id','searchinput2')
                    //     $('#select_input2 input').attr('onblur','resetinput2()')
                    // }, 1);
                    form.render('select')

                }
            },
            {method: 'POST'});
        layer.open({
            type: 1
            , title: '更多'
            , area: ['400px', '200px']//设置模态框宽度
            , content: '' + html + ''
            , btn: ['保存']
            , yes: function (index, layero) {
                delete dataobj2.responsiblepe
                delete dataobj2.updatetime;
                for (var key in dataobj2) {
                    if (dataobj2[key] == '') {
                        delete dataobj2[key]
                    }
                }
                dataobj2.updateperson = config.getAccount().userName;
                //按钮【按钮二】的回调

//                    var highriskdes = obj.highriskdes;
//                    obj.escalationriskdes = highriskdes;
                dataobj2.updateSupplierNumberFlag = true;
                dataobj2.oldSuppliernum = oldSuppliernum;
                admin.req('/api-edu/ppap/partslibrary/savePart', dataobj2, function (res) {
                    if (res.respCode == 200) {
                        layer.close(index);
                        // loadDatas();
                        //by ma 2019-04-10
                        layui.table.reload('parts-manage-table', {
                        });
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        })
                    }
                }, {method: 'POST'})
            }
        });
    }

    // function resetinput1() {
    //     var val = $('#searchinput1').val()
    //     setTimeout("$('#searchinput1').val('"+val+"')",155)
    //     dataobj2.suppliernum = val
    //     dataobj2.suppliername = $('#searchinput2').val()
    // }
    // function resetinput2() {
    //     var val = $('#searchinput2').val()
    //     setTimeout("$('#searchinput2').val('"+val+"')",155)
    //     dataobj2.suppliername = val
    //     dataobj2.suppliernum = $('#searchinput1').val()
    //
    // }
    //最新零件号和零件名称联动
    var selectdata2 = {};

    function openAll1(partskey, suppliernum, partsname, itemtrackingnum, latestpartnum, approvalstatus) {
        var form = layui.form,
            config = layui.config,
            admin = layui.adc;
        // if (approvalstatus == 6) {
        //     layer.msg('正在进行中，不可编辑！', {
        //         icon: 5
        //     });
        //     return;
        // }
        selectdata2 = {
            partskey: partskey,
            suppliernum: suppliernum,
            itemtrackingnum: itemtrackingnum,
            latestpartnum: latestpartnum,
            partsname: partsname,
            sqe: config.getAccount().userId
        }
        var html = '';
        html += '<div class="layui-form" style="padding-top: 10px"><div class="layui-row"><label class="layui-form-label" >最新零件号：</label>\n' +
            '                    <div class="layui-input-block">\n' +
            '                        <select class="layui-form-select" name="latestpartnum1" id="latestpartnum1"\n' +
            '                    lay-filter="latestpartnum1" lay-search=""></select>\n' +
            '                        </div></div>' +
            '<div class="layui-row"><label class="layui-form-label">零件名称：</label>' +
            '                    <div class="layui-input-block">' +
            '                        <select class="layui-form-select" name="partsname1" id="partsname1"' +
            '                    lay-filter="partsname1" lay-search=""></select>' +
            '                        </div></div></div>'
        var data = {};
        //供应商页面，无需判断其它
        data = {suppliernumber: USER.companyCode}
        admin.req('/api-edu/ppap/partslibrary/getPartsQueryItems', data, function (res) {
                if (res.respCode == 200 && res.data) {
                    $('#latestpartnum1').empty()
                    $('#partsname1').empty()
                    $('#latestpartnum1').append('<option value="">请选择</option>')
                    for (var i = 0; i < res.data.latestpartnum.length; i++) {
                        if (latestpartnum == res.data.latestpartnum[i]) {
                            $('#latestpartnum1').append('<option selected="selected">' + res.data.latestpartnum[i] + '</option>')
                        } else {
                            $('#latestpartnum1').append('<option>' + res.data.latestpartnum[i] + '</option>')
                        }
                    }
                    $('#partsname1').append('<option value="">请选择</option>')
                    for (var i = 0; i < res.data.partsname.length; i++) {
                        if (partsname == res.data.partsname[i]) {
                            $('#partsname1').append('<option selected="selected">' + res.data.partsname[i] + '</option>')
                        } else {
                            $('#partsname1').append('<option>' + res.data.partsname[i] + '</option>')
                        }
                    }
                    form.render('select')

                }
            },
            {method: 'POST'});
        layer.open({
            type: 1
            , title: '更多'
            , area: ['400px', '200px']//设置模态框宽度
            , content: '' + html + ''
            , btn: ['保存']
            , yes: function (index, layero) {
                delete selectdata2.responsiblepe
                delete selectdata2.updatetime;
                for (var key in selectdata2) {
                    if (selectdata2[key] == '') {
                        delete selectdata2[key]
                    }
                }
                selectdata2.updateperson = config.getAccount().userName;
                //按钮【按钮二】的回调
                admin.req('/api-edu/ppap/partslibrary/savePart', selectdata2, function (res) {
                    if (res.respCode == 200) {
                        layer.close(index);
                        // loadDatas();
                        // by ma 2019-04-10
                        layui.table.reload('parts-manage-table', {
                        });
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        })
                    }
                }, {method: 'POST'})
            }
        });
    }


    //根据登陆人查询sqe
    var selectdata3 = {};

    function openAll3(partskey, suppliernum, sqe, itemtrackingnum, latestpartnum, approvalstatus) {
        var form = layui.form,
            config = layui.config,
            admin = layui.adc;
        // if (approvalstatus == 6) {
        //     layer.msg('正在进行中，不可编辑！', {
        //         icon: 5
        //     });
        //     return;
        // }
        selectdata3 = {
            partskey: partskey,
            suppliernum: suppliernum,
            itemtrackingnum: itemtrackingnum,
            latestpartnum: latestpartnum,
            sqe: sqe
        }
        var html = '';
        html += '<div class="layui-form" style="padding-top: 10px"><div class="layui-row"><label class="layui-form-label">SQE：</label>\n' +
            '                    <div class="layui-input-block">\n' +
            '                        <select class="layui-form-select" name="sqe1" id="sqe1"\n' +
            '                    lay-filter="sqe1" lay-search=""></select>\n' +
            '                        </div></div>' +
            '</div>'
        admin.req('/api-edu/ppap/partslibrary/getAllSQEName', {userId: config.getAccount().userId,roleName: config.getAccount().roleName}, function (res) {
                if (res.respCode == 200 && res.data) {
                    $('#sqe1').empty()
                    $('#sqe1').append('<option value="">请选择</option>')
                    for (var i = 0; i < res.data.length; i++) {
                        if (sqe == res.data[i].userName) {
                            $('#sqe1').append('<option selected="selected">' + res.data[i].userName + '</option>')
                        } else {
                            $('#sqe1').append('<option>' + res.data[i].userName + '</option>')
                        }
                    }
                    form.render('select')

                }
            },
            {method: 'POST'});
        layer.open({
            type: 1
            , title: '更多'
            , area: ['400px', '200px']//设置模态框宽度
            , content: '' + html + ''
            , btn: ['保存']
            , closeBtn: 0 //马 2019-3-10 17:06 bug修复 零件信息维护-SQE主管新增零件，默认SQE显示主管自己【15618】
            , yes: function (index, layero) {
                //按钮【按钮二】的回调
                admin.req('/api-edu/ppap/partslibrary/savePart', selectdata3, function (res) {
                    if (res.respCode == 200) {
                        layer.close(index);
                        // loadDatas();
                        //by ma 2019-04-10
                        layui.table.reload('parts-manage-table', {
                        });
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        })
                    }
                }, {method: 'POST'})
            }
        });
    }


    //项目单编号弹层
    var selectdata4 = {};
    var thisdata

    function openAll4($this) {
        var form = layui.form,
            config = layui.config,
            admin = layui.adc;
        thisdata = JSON.parse($this[0].id)
        // if (thisdata.approvalstatus == 6) {
        //     layer.msg('正在进行中，不可编辑！', {
        //         icon: 5
        //     });
        //     return;
        // }
        var html = '';
        html += '<div class="layui-form" style="padding-top: 30px"><div class="layui-row"><label style="width: 135px" class="layui-form-label">项目单编号：</label>\n' +
            '                    <div style="margin-left: 166px" id="program_input" class="layui-input-block">\n' +
            '                        <select class="layui-form-select" name="itemtrackingnum1" id="itemtrackingnum1"\n' +
            '                    lay-filter="itemtrackingnum1"></select>\n' + //马 2019-3-11 20:10 bug修复 零件信息维护-数据编辑-【项目单编号】字段不可编辑 【15914】
            '                        </div></div>' +
            '</div>'
        html += '<div class="layui-form">' +
            '<div class="layui-row">' +
            '<label class="layui-form-label" style="width: 135px">车型/机型：</label>\n' +
            '                    <div style="margin-left: 166px" id="select_input" class="layui-input-block">\n' +
            '                        <select style="width: 100%" class="layui-form-select" name="projectmodelChange" id="projectmodelChange"\n' +
            '                    lay-filter="projectmodelChange" lay-search=""></select>\n' +
            '                        </div></div>' +
            '</div>'
        var data = {};
        //供应商页面，无需判断角色
        data = {suppliernumber: USER.companyCode}
        admin.req('/api-edu/ppap/partslibrary/getPartsQueryItems', data, function (res) {
                if (res.respCode == 200 && res.data) {
                    $('#itemtrackingnum1').empty()
                    $('#itemtrackingnum1').append('<option value="">请选择</option>')
                    for (var i = 0; i < res.data.itemtrackingnum.length; i++) {
                        if (thisdata.itemtrackingnum == res.data.itemtrackingnum[i]) {
                            $('#itemtrackingnum1').append('<option selected="selected">' + res.data.itemtrackingnum[i] + '</option>')
                        } else {
                            $('#itemtrackingnum1').append('<option>' + res.data.itemtrackingnum[i] + '</option>')
                        }
                    }
                    $('#projectmodelChange').empty()
                    $('#projectmodelChange').append('<option value="">请选择</option>')
                    for (var i = 0; i < res.data.projectmodel.length; i++) {
                        if (JSON.parse($this[0].id).projectmodel == res.data.projectmodel[i]) {
                            $('#projectmodelChange').append('<option selected="selected">' + res.data.projectmodel[i] + '</option>')
                        } else {
                            $('#projectmodelChange').append('<option>' + res.data.projectmodel[i] + '</option>')
                        }
                    }
                    /**马 2019-3-11 20:10 bug修复 零件信息维护-【项目车型/机型】字段不可编辑 【15521】**/
                    setTimeout(function () {
                        $('#select_input input').attr('id', 'searchinput1')
                        $('#program_input input').attr('id', 'programinput1')
                        $('#select_input input').attr('onblur', 'resetinput1()')
                    }, 1);
                    /**马 2019-3-11 20:10 bug修复 结束**/
                    form.render('select')

                }
            },
            {method: 'POST'});
        layer.open({
            type: 1
            , title: '更多'
            , area: ['400px', '200px']//设置模态框宽度
            , content: '' + html + ''
            , btn: ['保存']
            , yes: function (index, layero) {
                delete thisdata.responsiblepe
                delete thisdata.updatetime;
                for (var key in thisdata) {
                    /**马 2019-3-12 20:10 bug修复 【15615】**/
                    if (key === "itemtrackingnum") {
                        continue;
                    }
                    /**马 2019-3-12 20:10 bug修复 结束**/
                    if (thisdata[key] == '') {
                        delete thisdata[key]
                    };
                }
                /**马 2019-4-10  bug修复 项目车型/机型长度从30改为50  结束**/
                if(thisdata.hasOwnProperty('projectmodel') && thisdata.projectmodel.length > 50){
                    layer.alert('此项的输入长度不可超过50位！', {
                        icon: 5
                        ,btn:['关闭']
                    });
                    return;
                };

                // 张大伟 2019-3-27 客户最新需求，对项目车型不做校验【如果把这个校验关闭掉无法对比大项目名称因此还需要打开2019-4-1】
                if(thisdata.hasOwnProperty('projectmodel') && thisdata.projectmodel.indexOf("-") === -1){
                    layer.alert('此项必须存在英文中划线符号(-)，且不能位于首尾位置', {
                        icon: 5
                        ,btn:['关闭']
                    });
                    return;
                }
                //马    将highriskdes和escalationriskdes字段合为一个 2019-03-17
                var highriskdes = thisdata.highriskdes;
                thisdata.escalationriskdes = highriskdes;
                admin.req('/api-edu/ppap/partslibrary/savePart', thisdata, function (res) {
                    if (res.respCode == 200) {
                        layer.close(index);
                        // loadDatas();
                        //by ma 2019-04-10
                        layui.table.reload('parts-manage-table', {
                        });
                    } else {
                        layer.alert(res.message, {
                            icon: 5
                            ,btn:['关闭']
                        })
                    }
                }, {method: 'POST'})
            }
        });
    }
    /**马 2019-3-11 20:10 bug修复 零件信息维护-【项目车型/机型】字段不可编辑 【15521】**/
    function resetinput1() {
        var val = $('#searchinput1').val()
        setTimeout("$('#searchinput1').val('" + val + "')", 155)
        thisdata.projectmodel = $('#searchinput1').val()
        /**马 2019-3-12 20:10 bug修复 【15615】**/
        $('#programinput1').val("")
        thisdata.itemtrackingnum = ""
        /**马 2019-3-12 20:10 bug修复 结束**/
    }
    //显示
    function openAlla(d) {
        var arr = d.taskordernumber.split(',');
        var html = '<div style="text-align: center;height: 200px;overflow-y: auto">';
        for (var i = 0; i < arr.length; i++) {
            html += '<a href="##" onclick="jumpTaskOrderPage1(\''+arr[i]+'\',\''+d.taskorderkey+'\',\''+d.taskordertype+'\')" style=\'padding: 10px\'>' + arr[i] + '</a>'
        }
        html += '</div>'
        layer.open({
            type: 1
            , title: '更多'
            , area: ['500px', '300px']//设置模态框宽度
            , content: '' + html + ''
            , btn: ['关闭']
            , yes: function (index, layero) {
                //按钮【按钮二】的回调
                layer.close(index);
            }
        });
    }
    /**
     *  @Des 任务单编号跳转 bug13974
     *  @Author qitian
     */
    function jumpTaskOrderPage (d) {
        var admin = layui.adc,
            config = layui.config;
        event.preventDefault();
        if (d) {
            if (config.getAccount().roleName.indexOf('管理员') != -1 || config.getAccount().roleName.indexOf('动力总程科') != -1 || config.getAccount().roleName.indexOf('项目投产科') != -1) {
                var where = {
                    rolename: config.getAccount().roleName,
                    taskordernumber:d.taskordernumber
                }
            } else {
                var where = {
                    userId: config.getAccount().userId,
                    taskordernumber:d.taskordernumber
                }
            }
            /** 马 2019-03-11 bug修复 零件待办查询-任务单编号链接错误 相同bug 【15426】【15724】 **/
            admin.req('/api-edu/ppap/taskorder/selectyiban', where, function (res) {
                if(res[0]){
                    if (res[0].taskordertype == 1) {//opap
                    	 window.location.href =  './index.html#!opap3?' + res[0].taskorderkey+ '&' + res[0].processId + '&' + res[0].nodeid;
                    } else {//ppap
                    	  window.location.href = './index.html#!task-view-ppap-supplier?' + res[0].taskorderkey + '&' + res[0].processId + '&' + res[0].nodeid;
                    }
                }else{
                    layer.alert("数据异常！",{
                        icon: 1
                        ,btn:['关闭']
                    })
                }
            }, {method: 'POST'})
            /** 2019-03-11 bug修复 结束 【15426】【15724】 **/
        }
        layer.closeAll('page');
    }

    /**
     *  @Des 任务单编号(弹框内)跳转 bug13974
     *  @Author liuhuiwen
     */
    function jumpTaskOrderPage1 (taskordernumber,taskorderkey,taskordertype) {
        var admin = layui.adc,
            config = layui.config;
        event.preventDefault();
        if (taskordernumber) {
            if (config.getAccount().roleName.indexOf('管理员') != -1 || config.getAccount().roleName.indexOf('动力总程科') != -1 || config.getAccount().roleName.indexOf('项目投产科') != -1) {
                var where = {
                    rolename: config.getAccount().roleName,
                    taskordernumber:taskordernumber
                }
            } else {
                var where = {
                    userId: config.getAccount().userId,
                    taskordernumber:taskordernumber
                }
            }
            $.ajax({
                type: 'POST',
                url: admin.formatUrl('/api-edu/ppap/taskorder/searchTaskorderHave'),
                data: where,
                dataType: "json",
                success: function (res) {
                    /**马 2019-3-13 13:50 bug修复 零件信息管理[含两个子模块]-供应商登录-任务单编号没有超链接 【15711】**/
                    if (res.data.page[0].taskordertype == 1) {//opap
                    	window.location.href =  './index.html#!opap3?' + res.data.page[0].taskorderkey+ '&' + res.data.page[0].processId + '&' + res.data.page[0].nodeid;
                    } else {//ppap
                        window.location.href = './index.html#!task-view-ppap-supplier?' + res.data.page[0].taskorderkey + '&' + res.data.page[0].processId + '&' + res.data.page[0].nodeid;
                    }
                }
            });
        }
        layer.closeAll('page');
    }
    //by ma 2019/03/10 selectFrom 添加鼠标悬停显示全部
    $("#part_info_maintain").on('mouseover','.xm-form-checkbox',function (){
        var text = $(this).find("span").text()
        $(this).attr('title',text)
    });
</script>